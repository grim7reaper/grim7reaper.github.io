<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:base="https://grim7reaper.github.io/">
  <id>https://grim7reaper.github.io/</id>
  <title>grim7reaper</title>
  <updated>2023-01-09T00:00:00Z</updated>
  <link rel="alternate" href="https://grim7reaper.github.io/" type="text/html"/>
  <link rel="self" href="https://grim7reaper.github.io/atom.xml" type="application/atom+xml"/>
  <author>
    <name>Sylvain Laperche</name>
    <uri>/about</uri>
  </author>
  <entry>
    <id>tag:grim7reaper.github.io,2023-01-09:/blog/2023/01/09/the-hydronium-project/</id>
    <title type="html">Harder, Better, Faster, Stronger version of Uber H3 in Rust: The Hydronium Project</title>
    <published>2023-01-09T00:00:00Z</published>
    <updated>2023-01-09T00:00:00Z</updated>
    <link rel="alternate" href="https://grim7reaper.github.io/blog/2023/01/09/the-hydronium-project/" type="text/html"/>
    <content type="html">&lt;p&gt;
  Since this article will probably have more reach than my usual rambling, It'll
  be written in English (but let's not make a habit of it).
&lt;/p&gt;
&lt;p&gt;
  By the way, in case you missed it, the title is a reference to this
  &lt;a href="https://genius.com/Daft-punk-harder-better-faster-stronger-lyrics"&gt;song&lt;/a&gt;.
&lt;/p&gt;

&lt;h2&gt;h3o: the oxidized H3&lt;/h2&gt;

&lt;p&gt;
  &lt;a href="https://github.com/HydroniumLabs/h3o"&gt;h3o&lt;/a&gt; is not a binding (like
  &lt;a href="https://github.com/nmandery/h3ron"&gt;h3ron&lt;/a&gt;) but a complete rewrite
  of &lt;a href="https://github.com/uber/h3"&gt;H3&lt;/a&gt;.
&lt;/p&gt;
&lt;p&gt;
  The goals of this rewrite in Rust were:
  &lt;ul&gt;
    &lt;li&gt;
      an easier integration in Rust projects, especially when targeting WASM
    &lt;/li&gt;
    &lt;li&gt;
      to provide safer API, leveraging strong typing (e.g. having distinct types for each
      index mode)
    &lt;/li&gt;
    &lt;li&gt;
      to be faster (or at least as fast) than the reference library
    &lt;/li&gt;
    &lt;li&gt;
      to cover 100% of 4.0 API (current release at the time the project started)
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/p&gt;

&lt;h3&gt;Testing&lt;/h3&gt;

&lt;p&gt;
  Differential testing has been used to reduce the risk of regression/divergence
  from the reference implementation.
&lt;/p&gt;
&lt;p&gt;
  Each public function of &lt;code&gt;h3o&lt;/code&gt; has been tested, exhaustively on
  coarser resolutions when possible, against its counterpart in &lt;code&gt;H3&lt;/code&gt;
  (through the
  &lt;a href="https://github.com/nmandery/h3ron/tree/main/h3ron-h3-sys"&gt;h3ron-sys&lt;/a&gt;
  binding), except for geometrical functions (it's been postponed) because the
  conversion and robust comparison were a bit troublesome to implement.
&lt;/p&gt;
&lt;p&gt;
  In addition to the differential test suite (756 tests), there are 166
  integration tests (covering extra features no present in &lt;code&gt;H3&lt;/code&gt; such
  as GeoJSON helpers) and 42 unit tests (for internal functions).
&lt;/p&gt;
&lt;p&gt;
  Last but not least, 15 fuzz targets also have been implemented (doesn't cover
  the whole public API yet though, but it's a start).
&lt;/p&gt;

&lt;h3&gt;Performance&lt;/h3&gt;

&lt;p&gt;
  A benchmark suite composed of 911 test cases has been developed, covering the
  whole public API and comparing &lt;code&gt;h3o&lt;/code&gt; performance against the
  &lt;code&gt;H3&lt;/code&gt; reference implementation (through the &lt;code&gt;h3ron-sys&lt;/code&gt;
  crate which is expected to have no overhead).
&lt;/p&gt;
&lt;p&gt;
Full results are available
&lt;a href="/static/misc/critcmp.txt"&gt;here&lt;/a&gt;.
You can also run the benchmarks locally:
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;cargo bench --bench h3 --all-features -- --save-baseline h3 '/h3/'
cargo bench --bench h3 --all-features -- --save-baseline h3 '/h3$'

cargo bench --bench h3 --all-features -- --save-baseline h3o '/h3o/'
cargo bench --bench h3 --all-features -- --save-baseline h3o '/h3o$'

critcmp h3 h3o -g '(.+/)(?:h3o?)(/?.*)'
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;h4&gt;Overview&lt;/h4&gt;

&lt;p&gt;
  Before diving into the results, a quick overview:
  &lt;ul&gt;
    &lt;li&gt;5 tests where the performance is equals&lt;/li&gt;
    &lt;li&gt;44 tests where &lt;code&gt;H3&lt;/code&gt; still outperform &lt;code&gt;h3o&lt;/code&gt;&lt;/li&gt;
    &lt;ul&gt;
      &lt;li&gt;
        34 tests where &lt;code&gt;H3&lt;/code&gt; is marginally faster (the difference is
        10% or less)
      &lt;/li&gt;
      &lt;li&gt;
        5 tests where &lt;code&gt;H3&lt;/code&gt; is faster (the difference is between 11%
        and 20%)
      &lt;/li&gt;
      &lt;li&gt;
        4 tests where &lt;code&gt;H3&lt;/code&gt; is noticeably faster (the difference is up
        to 50%)
      &lt;/li&gt;
      &lt;li&gt;
        1 test where &lt;code&gt;H3&lt;/code&gt; is twice as fast
        (&lt;code&gt;gridDiskDistancesSafe/Hexagon/1&lt;/code&gt;)
      &lt;/li&gt;
    &lt;/ul&gt;
    &lt;li&gt;862 tests where &lt;code&gt;h3o&lt;/code&gt; outperforms &lt;code&gt;H3&lt;/code&gt;&lt;/li&gt;
    &lt;ul&gt;
      &lt;li&gt;166 with a difference between 1% and 10%&lt;/li&gt;
      &lt;li&gt;195 with a difference between 11% and 20%&lt;/li&gt;
      &lt;li&gt;163 with a difference between 21% and 50%&lt;/li&gt;
      &lt;li&gt;48 where &lt;code&gt;h3o&lt;/code&gt; is up to 2x faster&lt;/li&gt;
      &lt;li&gt;93 where &lt;code&gt;h3o&lt;/code&gt; is up to 3x faster&lt;/li&gt;
      &lt;li&gt;84 where &lt;code&gt;h3o&lt;/code&gt; is up to 4x faster&lt;/li&gt;
      &lt;li&gt;43 where &lt;code&gt;h3o&lt;/code&gt; is up to 5x faster&lt;/li&gt;
      &lt;li&gt;46 where &lt;code&gt;h3o&lt;/code&gt; is up to 10x faster&lt;/li&gt;
      &lt;li&gt;24 where &lt;code&gt;h3o&lt;/code&gt; more than 10x faster&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/ul&gt;
&lt;/p&gt;

&lt;p&gt;
  Most of the tests where &lt;code&gt;h3o&lt;/code&gt; is slower are limited to coarse
  resolutions (&amp;lt; 3 for half of them) which are usually fast anyway (still,
  would be nice if we could be on par here as well), the only exceptions being:
  &lt;ul&gt;
    &lt;li&gt;
      &lt;code&gt;cellToLatLng&lt;/code&gt; for class Ⅲ resolutions especially on
      pentagons.
    &lt;/li&gt;
    &lt;li&gt;&lt;code&gt;latLngToCell&lt;/code&gt; for pentagon&lt;/li&gt;
  &lt;/ul&gt;
  &lt;br/&gt;
  Will probably dive into those two cases as they shouldn't be slower.
&lt;/p&gt;
&lt;p&gt;
  Let's now look closer at some interesting benchmark results, and describe the
  optimizations behind them.
&lt;/p&gt;

&lt;h4&gt;cellToBoundary&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/cellToBoundary.png" class="centered" title="cellToBoundary benchmark" alt="cellToBoundary benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;
  Not a huge win on this one (up to 40% for the finer resolutions), but we can
  see the impact of edge-crossing handling for pentagons at resolutions of class
  Ⅲ (class Ⅱ aren't impacted because at those resolutions edges have vertices on
  the same icosahedron face).
&lt;/p&gt;

&lt;h4&gt;cellToChildrenSize&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/cellToChildrenSize.png" class="centered" title="cellToChildrenSize benchmark" alt="cellToChildrenSize benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;
  &lt;code&gt;H3&lt;/code&gt; is using a formula to compute it on the fly (you can notice a
  small jump at each power of two due to their &lt;code&gt;ipow&lt;/code&gt; implementation)
  whereas &lt;code&gt;h3o&lt;/code&gt; uses a lookup table of pre-computed values.
  &lt;br /&gt;
  Same thing for &lt;code&gt;getNumCells&lt;/code&gt;.
&lt;/p&gt;

&lt;h4&gt;cellToLatLng&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/cellToLatLng.png" class="centered" title="cellToLatLng benchmark" alt="cellToLatLng benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;
  One of the cases where &lt;code&gt;H3&lt;/code&gt; is consistently faster than
  &lt;code&gt;h3o&lt;/code&gt;: for pentagons at resolutions of class Ⅲ.
  &lt;br/&gt;
  I've probably messed up something in this specific case, will have to dig into
  it because there is no reason why we would be faster on class Ⅱ but not class
  Ⅲ.
&lt;/p&gt;

&lt;h4&gt;cellToParent&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/cellToParent.png" class="centered" title="cellToParent benchmark" alt="cellToParent benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;
  &lt;code&gt;H3&lt;/code&gt; uses a loop to "clear" (set to &lt;code&gt;0b111&lt;/code&gt;) the
  trailing unused bits at the targeted parent resolution, resulting in an
  &lt;code&gt;O(n)&lt;/code&gt; algorithm where &lt;code&gt;n&lt;/code&gt; is the difference between the
  child cell resolution and the one of the requested parent.
  &lt;br/&gt;
  The benchmark uses a cell index at resolution 15 as input, that's why the
  coarser the resolution gets, the slower the algorithm is.
  &lt;br/&gt;
  On the other hand, &lt;code&gt;h3o&lt;/code&gt; uses a constant-time approach based on bit
  twiddling, hence the flatline.
&lt;/p&gt;

&lt;h4&gt;compactCell&lt;/h4&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Test case&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;H3&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;h3o&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;Speedup&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;&lt;td&gt;NoCompaction&lt;/td&gt;      &lt;td&gt;326.5±3.07µs&lt;/td&gt;&lt;td&gt;243.9±1.13µs&lt;/td&gt;&lt;td&gt;1.34&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;PartialCompaction&lt;/td&gt; &lt;td&gt;326.0±2.56µs&lt;/td&gt;&lt;td&gt;206.6±1.14µs&lt;/td&gt;&lt;td&gt;1.58&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;FullCompaction&lt;/td&gt;    &lt;td&gt;318.4±4.66µs&lt;/td&gt;&lt;td&gt;134.0±0.78µs&lt;/td&gt;&lt;td&gt;2.38&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
  The &lt;code&gt;h3o&lt;/code&gt; implementation is not a port of the &lt;code&gt;H3&lt;/code&gt;
  algorithm.
  &lt;br/&gt;
  &lt;code&gt;H3&lt;/code&gt; iteratively compacts the input set until it reaches a stable
  (i.e. non-compactable) state.
  &lt;br/&gt;
  &lt;code&gt;h3o&lt;/code&gt; starts by sorting the input set, and then compacts chunks of
  adjacent indexes (from coarser to finer resolution), effectively galloping
  through the data (hence the bigger speedup on a fully compactable set) in a
  single pass.
&lt;/p&gt;

&lt;h4&gt;gridDiskDistancesSafe&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/gridDiskDistancesSafe.png" class="centered" title="gridDiskDistancesSafe benchmark" alt="gridDiskDistancesSafe benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;Here are the measures for hexagons (pentagons are in the same ballpark).&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Test case&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;H3&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;h3o&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;Speedup&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/0&lt;/td&gt;   &lt;td&gt;   3.6±0.08ns&lt;/td&gt; &lt;td&gt;   1.2±0.01ns&lt;/td&gt;  &lt;td&gt; 2.87&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/1&lt;/td&gt;   &lt;td&gt;  85.2±2.56ns&lt;/td&gt; &lt;td&gt; 170.7±2.66ns&lt;/td&gt;  &lt;td&gt; 0.50&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/2&lt;/td&gt;   &lt;td&gt; 448.9±6.28ns&lt;/td&gt; &lt;td&gt; 635.7±8.90ns&lt;/td&gt;  &lt;td&gt; 0.70&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/3&lt;/td&gt;   &lt;td&gt;1724.1±22.38ns&lt;/td&gt;&lt;td&gt;1504.1±6.71ns&lt;/td&gt;  &lt;td&gt; 1.15&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/4&lt;/td&gt;   &lt;td&gt;   4.6±0.05µs&lt;/td&gt; &lt;td&gt;   2.8±0.02µs&lt;/td&gt;  &lt;td&gt; 1.67&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/5&lt;/td&gt;   &lt;td&gt;  16.0±0.46µs&lt;/td&gt; &lt;td&gt;   4.5±0.03µs&lt;/td&gt;  &lt;td&gt; 3.52&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/6&lt;/td&gt;   &lt;td&gt;  21.4±0.69µs&lt;/td&gt; &lt;td&gt;   6.6±0.03µs&lt;/td&gt;  &lt;td&gt; 3.24&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/7&lt;/td&gt;   &lt;td&gt;  26.2±0.66µs&lt;/td&gt; &lt;td&gt;   9.6±0.16µs&lt;/td&gt;  &lt;td&gt; 2.72&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/8&lt;/td&gt;   &lt;td&gt;  74.8±0.79µs&lt;/td&gt; &lt;td&gt;  13.4±0.21µs&lt;/td&gt;  &lt;td&gt; 5.60&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/9&lt;/td&gt;   &lt;td&gt;  58.1±0.59µs&lt;/td&gt; &lt;td&gt;  16.1±0.16µs&lt;/td&gt;  &lt;td&gt; 3.62&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/10&lt;/td&gt;  &lt;td&gt; 150.4±1.64µs&lt;/td&gt; &lt;td&gt;  20.5±0.13µs&lt;/td&gt;  &lt;td&gt; 7.34&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/20&lt;/td&gt;  &lt;td&gt;1658.4±15.81µs&lt;/td&gt;&lt;td&gt;  90.5±0.59µs&lt;/td&gt;  &lt;td&gt;18.33&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/30&lt;/td&gt;  &lt;td&gt;   3.3±0.06ms&lt;/td&gt; &lt;td&gt; 219.7±2.03µs&lt;/td&gt;  &lt;td&gt;14.87&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/40&lt;/td&gt;  &lt;td&gt;  11.2±0.04ms&lt;/td&gt; &lt;td&gt; 480.3±79.36µs&lt;/td&gt; &lt;td&gt;23.35&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/50&lt;/td&gt;  &lt;td&gt;  28.3±0.12ms&lt;/td&gt; &lt;td&gt; 614.1±42.11µs&lt;/td&gt; &lt;td&gt;46.06&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Hexagon/100&lt;/td&gt; &lt;td&gt; 140.3±0.43ms&lt;/td&gt; &lt;td&gt;   2.6±0.11ms&lt;/td&gt;  &lt;td&gt;54.98&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;
  This is one of the functions where &lt;code&gt;h3o&lt;/code&gt; shines the most, which is a
  bit surprising considering the implementations are similar.
&lt;/p&gt;
&lt;p&gt;
  One reason could be that the &lt;code&gt;H3&lt;/code&gt; code uses recursion, whereas
  &lt;code&gt;h3o&lt;/code&gt; uses an iterative implementation (given that TCO, tail-call
  optimization, is not guaranteed in Rust, it's usually safer to avoid recursion
  when possible).
&lt;/p&gt;
&lt;p&gt;
  Another reason, that seems more plausible to me, is that &lt;code&gt;H3&lt;/code&gt; uses
  a homemade hash table that resolves collision using open addressing in
  conjunction with linear probing.
  &lt;br/&gt;
  The issue with this strategy is that the performance will go down the drain as
  soon as the load factor becomes too high, which is exactly what is happening
  here considering &lt;code&gt;H3&lt;/code&gt; uses the output array as a hash table and
  this array is sized to contain exactly the number of output cell: as the
  algorithm progress, the load factor increase until it reaches 100%.
  &lt;br/&gt;
  While this isn't noticeable on smaller disks, as the disk becomes larger (and
  thus the number of indexes increases), the impact of the linear probing
  becomes prohibitive.
&lt;/p&gt;

&lt;h4&gt;h3SetToLinkedGeo&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/h3SetToLinkedGeo.png" class="centered" title="h3SetToLinkedGeo benchmark" alt="h3SetToLinkedGeo benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;
  In this test, the speed difference between &lt;code&gt;H3&lt;/code&gt; and
  &lt;code&gt;h3o&lt;/code&gt; is relatively small, until you reach a certain amount of
  indexes in the input set where the &lt;code&gt;H3&lt;/code&gt; runtime skyrocket.
&lt;/p&gt;
&lt;p&gt;
  It's the same issue that they have in &lt;code&gt;gridDiskDistancesSafe&lt;/code&gt;: the
  homemade hash table buckles down under the load.
  &lt;br/&gt;
  The reason why is a bit different though is because the hash table used to
  implement the vertex graph in &lt;code&gt;H3&lt;/code&gt; uses separate chaining to
  resolve the collision. That being said, the table is never resized and if the
  number of buckets initially selected becomes too small (and/or the hash
  function doesn't have a good distribution), then some chains will become quite
  large and you quickly end up with &lt;code&gt;O(n)&lt;/code&gt; operations.
&lt;/p&gt;
&lt;p&gt;
  &lt;code&gt;h3o&lt;/code&gt; uses the same approach as &lt;code&gt;H3&lt;/code&gt; to detect the
  outlines of the shapes (based on a vertex graph) but uses a different
  algorithm to identify outer and inner rings and grouping into polygons.
  &lt;br/&gt;
  Seems like the &lt;code&gt;h3o&lt;/code&gt; approach performs better for nested shapes
  (e.g. concentric rings), maybe because it uses fewer point-in-polygon checks?
&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Test case&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;H3&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;h3o&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;Speedup&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;&lt;td&gt;0 rings&lt;/td&gt;&lt;td&gt;1888.4±11.33ns&lt;/td&gt; &lt;td&gt;1421.9±14.58ns&lt;/td&gt; &lt;td&gt;1.33&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;1 rings&lt;/td&gt;&lt;td&gt;  34.3±0.13µs&lt;/td&gt;  &lt;td&gt;  19.4±0.17µs&lt;/td&gt;  &lt;td&gt;1.77&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;2 rings&lt;/td&gt;&lt;td&gt; 115.1±0.61µs&lt;/td&gt;  &lt;td&gt;  63.9±0.54µs&lt;/td&gt;  &lt;td&gt;1.80&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;3 rings&lt;/td&gt;&lt;td&gt; 293.2±1.59µs&lt;/td&gt;  &lt;td&gt; 144.4±2.33µs&lt;/td&gt;  &lt;td&gt;2.03&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;4 rings&lt;/td&gt;&lt;td&gt; 558.6±17.99µs&lt;/td&gt; &lt;td&gt; 265.6±3.08µs&lt;/td&gt;  &lt;td&gt;2.10&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;5 rings&lt;/td&gt;&lt;td&gt; 968.6±5.12µs&lt;/td&gt;  &lt;td&gt; 432.0±8.02µs&lt;/td&gt;  &lt;td&gt;2.24&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h4&gt;isPentagon&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/isPentagon.png" class="centered" title="isPentagon benchmark" alt="isPentagon benchmark"&gt;
&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Resolution&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;H3&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;h3o&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;Speedup&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;&lt;td&gt;0&lt;/td&gt; &lt;td&gt;2.2±0.05ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;2.00&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;1&lt;/td&gt; &lt;td&gt;2.2±0.02ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;1.99&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;2&lt;/td&gt; &lt;td&gt;2.2±0.02ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;2.01&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;3&lt;/td&gt; &lt;td&gt;3.9±0.03ns&lt;/td&gt;&lt;td&gt;1.1±0.03ns&lt;/td&gt;&lt;td&gt;3.48&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;4&lt;/td&gt; &lt;td&gt;4.1±0.03ns&lt;/td&gt;&lt;td&gt;1.1±0.02ns&lt;/td&gt;&lt;td&gt;3.70&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;5&lt;/td&gt; &lt;td&gt;4.4±0.04ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;3.97&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;6&lt;/td&gt; &lt;td&gt;4.7±0.04ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;4.26&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;7&lt;/td&gt; &lt;td&gt;5.0±0.04ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;4.54&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;8&lt;/td&gt; &lt;td&gt;5.3±0.07ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;4.83&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;9&lt;/td&gt; &lt;td&gt;5.7±0.11ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;5.16&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;10&lt;/td&gt;&lt;td&gt;5.9±0.07ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;5.38&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;11&lt;/td&gt;&lt;td&gt;6.3±0.13ns&lt;/td&gt;&lt;td&gt;1.1±0.02ns&lt;/td&gt;&lt;td&gt;5.68&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;12&lt;/td&gt;&lt;td&gt;6.6±0.33ns&lt;/td&gt;&lt;td&gt;1.1±0.02ns&lt;/td&gt;&lt;td&gt;5.92&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;13&lt;/td&gt;&lt;td&gt;6.9±0.15ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;6.28&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;14&lt;/td&gt;&lt;td&gt;7.2±0.04ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;6.50&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;15&lt;/td&gt;&lt;td&gt;7.5±0.04ns&lt;/td&gt;&lt;td&gt;1.1±0.01ns&lt;/td&gt;&lt;td&gt;6.79&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
  &lt;code&gt;H3&lt;/code&gt; uses a loop (&lt;code&gt;O(resolution)&lt;/code&gt;) whereas
  &lt;code&gt;h3o&lt;/code&gt; relies on a 128-bit bitmap to provide a &lt;code&gt;O(1)&lt;/code&gt;
  test.
&lt;/p&gt;

&lt;h4&gt;isValidCell&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/isValidCell.png" class="centered" title="isValidCell benchmark" alt="isValidCell benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;
  Like what has been done for &lt;code&gt;isPentagon&lt;/code&gt;, every loop in the
  &lt;code&gt;H3&lt;/code&gt; implementation has been converted into constant-time
  operations thanks to clever bit-twiddling tricks.
  &lt;br/&gt;
  The curious reader can look at the implementation, lengthily documented, in
  &lt;a href="https://github.com/HydroniumLabs/h3o/blob/master/src/index/cell.rs"&gt;src/index/cell.rs&lt;/a&gt;
  (look for &lt;code&gt;TryFrom&amp;lt;u64&amp;gt;&lt;/code&gt; and &lt;code&gt;has_unused_direction&lt;/code&gt;).
&lt;/p&gt;
&lt;p&gt;
  The same pattern can be observed on &lt;code&gt;isValidDirectedEdge&lt;/code&gt;, for the
  same reasons.
&lt;p&gt;

&lt;h4&gt;latLngToCell&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/latLngToCell.png" class="centered" title="latLngToCell benchmark" alt="latLngToCell benchmark"&gt;
&lt;/p&gt;
&lt;p&gt;
  On hexagons, &lt;code&gt;h3o&lt;/code&gt; has a nice performance advantage (20 to 60%),
  maybe because it has an &lt;code&gt;O(1)&lt;/code&gt; cell rotation for hexagons
  (&lt;code&gt;H3&lt;/code&gt; has an &lt;code&gt;O(rotation count)&lt;/code&gt; one).
&lt;/p&gt;
&lt;p&gt;
  On the other hand, we're consistently slower (5 to 10%) than &lt;code&gt;H3&lt;/code&gt;
  on pentagons, which should be investigated at some point.
&lt;/p&gt;

&lt;h4&gt;maxPolygonToCellsSize&lt;/h4&gt;
&lt;p&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;code&gt;H3&lt;/code&gt;: 4.8±0.08µs&lt;/li&gt;
    &lt;li&gt;&lt;code&gt;h3o&lt;/code&gt;: 35.4±0.18ns&lt;/li&gt;
  &lt;/ul&gt;
  Thus, a x136 speedup!
  &lt;br /&gt;
  But this is misleading.
&lt;/p&gt;
&lt;p&gt;
  What happens here is that &lt;code&gt;h3o&lt;/code&gt; works on special geometry types that (amongst other things):
  &lt;ul&gt;
    &lt;li&gt;check that geometry is correct (e.g. no infinite coordinates)&lt;/li&gt;
    &lt;li&gt;compute the bounding box&lt;/li&gt;
  &lt;/ul&gt;
  Because of that, some computation costs are pre-paid when you're calling
  geometrical functions of those shapes (which is pretty cool if you reuse a
  shape several times since you'll pay those costs only once).
&lt;/p&gt;
&lt;p&gt;
  And that's what we see here: in &lt;code&gt;H3&lt;/code&gt;
  &lt;code&gt;maxPolygonToCellsSize&lt;/code&gt; computes the bounding box &lt;b&gt;AND&lt;/b&gt;
  estimates the number of indexes, whereas in &lt;code&gt;h3o&lt;/code&gt; we only do the
  estimation.
&lt;/p&gt;
&lt;p&gt;
  Because of this API, in &lt;code&gt;H3&lt;/code&gt; you'll usually end up computing the
  bounding box twice: once to estimate the size of the output set and again when
  computing the indexes set.
&lt;/p&gt;

&lt;h4&gt;polygonToCells&lt;/h4&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Resolution&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;H3&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;h3o&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;Speedup&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;&lt;td&gt;0 &lt;/td&gt;&lt;td&gt;  1.2±0.02ms&lt;/td&gt;&lt;td&gt;163.4±1.52µs &lt;/td&gt;&lt;td&gt; 7.07&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;1 &lt;/td&gt;&lt;td&gt;  2.0±0.03ms&lt;/td&gt;&lt;td&gt;202.2±2.34µs &lt;/td&gt;&lt;td&gt;10.02&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;2 &lt;/td&gt;&lt;td&gt;  1.2±0.01ms&lt;/td&gt;&lt;td&gt;215.7±0.92µs &lt;/td&gt;&lt;td&gt; 5.59&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;3 &lt;/td&gt;&lt;td&gt;  2.1±0.03ms&lt;/td&gt;&lt;td&gt;227.8±2.06µs &lt;/td&gt;&lt;td&gt; 9.02&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;4 &lt;/td&gt;&lt;td&gt;  1.3±0.01ms&lt;/td&gt;&lt;td&gt;244.2±3.68µs &lt;/td&gt;&lt;td&gt; 5.25&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;5 &lt;/td&gt;&lt;td&gt;  2.2±0.02ms&lt;/td&gt;&lt;td&gt;257.3±2.62µs &lt;/td&gt;&lt;td&gt; 8.37&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;6 &lt;/td&gt;&lt;td&gt;  1.4±0.01ms&lt;/td&gt;&lt;td&gt;279.3±3.38µs &lt;/td&gt;&lt;td&gt; 5.11&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;7 &lt;/td&gt;&lt;td&gt;  2.5±0.02ms&lt;/td&gt;&lt;td&gt;371.9±10.09µs&lt;/td&gt;&lt;td&gt; 6.69&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;8 &lt;/td&gt;&lt;td&gt;  2.4±0.02ms&lt;/td&gt;&lt;td&gt;789.2±21.81µs&lt;/td&gt;&lt;td&gt; 3.10&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;9 &lt;/td&gt;&lt;td&gt;  7.3±0.02ms&lt;/td&gt;&lt;td&gt;  3.3±0.06ms &lt;/td&gt;&lt;td&gt; 2.19&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;10&lt;/td&gt;&lt;td&gt; 25.6±0.15ms&lt;/td&gt;&lt;td&gt; 19.5±0.33ms &lt;/td&gt;&lt;td&gt; 1.31&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;11&lt;/td&gt;&lt;td&gt;146.3±0.63ms&lt;/td&gt;&lt;td&gt;127.1±1.34ms &lt;/td&gt;&lt;td&gt; 1.15&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;12&lt;/td&gt;&lt;td&gt;938.9±3.41ms&lt;/td&gt;&lt;td&gt;868.2±9.16ms &lt;/td&gt;&lt;td&gt; 1.08&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
  Seems like the more indexes there are in the output, the smaller the gap
  between &lt;code&gt;H3&lt;/code&gt; and &lt;code&gt;h3o&lt;/code&gt;.
&lt;/p&gt;
&lt;p&gt;
  One thing to notice though is that &lt;code&gt;H3&lt;/code&gt; seems to have a noticeable
  overhead for class Ⅲ resolutions.
&lt;br/&gt;
  Doesn't seems to be the case for &lt;code&gt;h3o&lt;/code&gt;, and I'm not sure why
  (&lt;code&gt;gridDisk&lt;/code&gt; being in the inner loop, the difference probably stems
  from here).
&lt;/p&gt;

&lt;h4&gt;stringToH3&lt;/h4&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Index&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;H3&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;h3o&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;Speedup&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;&lt;td&gt;Cell index&lt;/td&gt;  &lt;td&gt;69.5±0.99ns&lt;/td&gt;&lt;td&gt;14.8±0.13ns&lt;/td&gt;&lt;td&gt;4.68&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Edge index&lt;/td&gt;  &lt;td&gt;71.1±0.33ns&lt;/td&gt;&lt;td&gt;19.4±0.15ns&lt;/td&gt;&lt;td&gt;3.67&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;Vertex index&lt;/td&gt;&lt;td&gt;72.8±0.47ns&lt;/td&gt;&lt;td&gt;20.6±0.11ns&lt;/td&gt;&lt;td&gt;3.54&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;
  This one is interesting!
&lt;/p&gt;
&lt;p&gt;
  The &lt;code&gt;H3&lt;/code&gt; implementation is nothing more than a sscanf, with no
  extra validity check whatsoever (i.e it just checks that the string is a valid
  hex representation of an unsigned 64-bit number).
  &lt;br/&gt;
  In &lt;code&gt;h3o&lt;/code&gt; we call &lt;code&gt;isValidXXX&lt;/code&gt; on the parsed string, to
  ensure that the resulting number is indeed a valid index. And even with that,
  it's still faster: nice.
&lt;/p&gt;
&lt;p&gt;
  It's probably because parsing an integer from a string is faster in Rust than
  using &lt;code&gt;sscanf&lt;/code&gt; in C. To be honest, this is not surprising given
  that &lt;code&gt;scanf&lt;/code&gt; functions family is kinda generic as it needs to parse
  a lot of different things. &lt;code&gt;H3&lt;/code&gt; could probably be faster here by
  using a function from the &lt;code&gt;strtoul&lt;/code&gt; family (since they are more
  specialized, they ought to be faster).
&lt;/p&gt;

&lt;h2&gt;h3-on-h3o (a.k.a h3oh3o): the H3-compatible C binding&lt;/h2&gt;

&lt;p&gt;
  Once the Rust version is complete, it's time to export us to other languages!
&lt;/p&gt;
&lt;p&gt;
  The preferred path would be to have a C API as close as idiomatically possible
  to the Rust one, and also a series of native bindings (using
  &lt;a href="https://cxx.rs"&gt;CXX&lt;/a&gt; for C++,
  &lt;a href="https://github.com/PyO3/pyo3"&gt;PyO3&lt;/a&gt; for Python,
  &lt;a href="https://github.com/danielpclark/rutie"&gt;rutie&lt;/a&gt; for Ruby,
  &lt;a href="https://mozilla.github.io/uniffi-rs/"&gt;uniffi&lt;/a&gt; for Swift and
  Kotlin, etc.).
&lt;/p&gt;
&lt;p&gt;
  Another path is to write a C API that mimics the &lt;code&gt;H3&lt;/code&gt; one which
  allows easier testing of &lt;code&gt;h3o&lt;/code&gt; in C project without modifying the
  code and leverages existing bindings by replacing &lt;code&gt;H3&lt;/code&gt; with
  &lt;code&gt;h3o&lt;/code&gt; with minimal changes.
&lt;/p&gt;
&lt;p&gt;
  While I prefer the former path, I started with the latter since it was the
  quickest one to allow those who are interested to test h3o with a minimal
  amount of friction.
&lt;/p&gt;
&lt;p&gt;
  And here we are with "H3 on h3o", a.k.a the
  &lt;a href="https://github.com/HydroniumLabs/h3oh3o"&gt;h3oh3o&lt;/a&gt; C library.
&lt;/p&gt;
&lt;p&gt;
  An advantage of being isofunctional with &lt;code&gt;H3&lt;/code&gt; in terms of API is
  that we can leverage their test suites and benchmarks. Let's see how the
  binding performs compared to the original one:
&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Test&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;H3&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;h3o&lt;/code&gt;&lt;/th&gt;
      &lt;th&gt;&lt;code&gt;Speedup&lt;/code&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;&lt;td&gt;latLngToCell                         &lt;/td&gt;&lt;td&gt;    0.8463µs&lt;/td&gt;&lt;td&gt;    0.3880µs&lt;/td&gt;&lt;td&gt; 2.18&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellToLatLng                         &lt;/td&gt;&lt;td&gt;    0.5839µs&lt;/td&gt;&lt;td&gt;    0.2223µs&lt;/td&gt;&lt;td&gt; 2.63&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellToBoundary                       &lt;/td&gt;&lt;td&gt;    1.9786µs&lt;/td&gt;&lt;td&gt;    0.8314µs&lt;/td&gt;&lt;td&gt; 2.38&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDisk10                           &lt;/td&gt;&lt;td&gt;    8.1998µs&lt;/td&gt;&lt;td&gt;    4.0217µs&lt;/td&gt;&lt;td&gt; 2.04&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDisk20                           &lt;/td&gt;&lt;td&gt;   18.7210µs&lt;/td&gt;&lt;td&gt;   15.6767µs&lt;/td&gt;&lt;td&gt; 1.19&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDisk30                           &lt;/td&gt;&lt;td&gt;   41.1222µs&lt;/td&gt;&lt;td&gt;   34.9652µs&lt;/td&gt;&lt;td&gt; 1.18&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDisk40                           &lt;/td&gt;&lt;td&gt;   72.2542µs&lt;/td&gt;&lt;td&gt;   60.2216µs&lt;/td&gt;&lt;td&gt; 1.20&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDiskPentagon10                   &lt;/td&gt;&lt;td&gt;   98.4980µs&lt;/td&gt;&lt;td&gt;   20.0700µs&lt;/td&gt;&lt;td&gt; 4.91&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDiskPentagon20                   &lt;/td&gt;&lt;td&gt;  900.3940µs&lt;/td&gt;&lt;td&gt;   83.7700µs&lt;/td&gt;&lt;td&gt;10.75&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDiskPentagon30                   &lt;/td&gt;&lt;td&gt; 3041.5400µs&lt;/td&gt;&lt;td&gt;  194.8000µs&lt;/td&gt;&lt;td&gt;15.61&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridDiskPentagon40                   &lt;/td&gt;&lt;td&gt; 7308.9000µs&lt;/td&gt;&lt;td&gt;  352.7000µs&lt;/td&gt;&lt;td&gt;20.72&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridPathCellsNear                    &lt;/td&gt;&lt;td&gt;    9.3828µs&lt;/td&gt;&lt;td&gt;    4.7500µs&lt;/td&gt;&lt;td&gt; 1.98&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;gridPathCellsFar                     &lt;/td&gt;&lt;td&gt;  413.6840µs&lt;/td&gt;&lt;td&gt;  202.5150µs&lt;/td&gt;&lt;td&gt; 2.04&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;directedEdgeToBoundary               &lt;/td&gt;&lt;td&gt;    5.0940µs&lt;/td&gt;&lt;td&gt;    2.4453µs&lt;/td&gt;&lt;td&gt; 2.08&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellToVertexes                       &lt;/td&gt;&lt;td&gt;    3.4804µs&lt;/td&gt;&lt;td&gt;    1.3102µs&lt;/td&gt;&lt;td&gt; 2.66&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellToVertexesPent                   &lt;/td&gt;&lt;td&gt;    0.0940µs&lt;/td&gt;&lt;td&gt;    0.0218µs&lt;/td&gt;&lt;td&gt; 4.31&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellToVertexesRing                   &lt;/td&gt;&lt;td&gt;   26.0935µs&lt;/td&gt;&lt;td&gt;   19.3975µs&lt;/td&gt;&lt;td&gt; 1.35&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellToVertexesRingPent               &lt;/td&gt;&lt;td&gt;   22.3335µs&lt;/td&gt;&lt;td&gt;   16.7243µs&lt;/td&gt;&lt;td&gt; 1.34&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;pentagonChildren_2_8                 &lt;/td&gt;&lt;td&gt; 1230.5830µs&lt;/td&gt;&lt;td&gt;  306.0520µs&lt;/td&gt;&lt;td&gt; 4.02&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;pentagonChildren_8_14                &lt;/td&gt;&lt;td&gt; 1639.8300µs&lt;/td&gt;&lt;td&gt;  305.7790µs&lt;/td&gt;&lt;td&gt; 5.36&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;pentagonChildren_8_14_null_2         &lt;/td&gt;&lt;td&gt;  911.4570µs&lt;/td&gt;&lt;td&gt;  290.7800µs&lt;/td&gt;&lt;td&gt; 3.13&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;pentagonChildren_8_14_null_10        &lt;/td&gt;&lt;td&gt; 1524.6970µs&lt;/td&gt;&lt;td&gt;  320.1670µs&lt;/td&gt;&lt;td&gt; 4.76&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;pentagonChildren_8_14_null_100       &lt;/td&gt;&lt;td&gt; 1629.4420µs&lt;/td&gt;&lt;td&gt;  311.7200µs&lt;/td&gt;&lt;td&gt; 5.23&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellsToLinkedMultiPolygonRing2       &lt;/td&gt;&lt;td&gt;   35.9619µs&lt;/td&gt;&lt;td&gt;   21.0267µs&lt;/td&gt;&lt;td&gt; 1.71&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellsToLinkedMultiPolygonDonut       &lt;/td&gt;&lt;td&gt;   11.4595µs&lt;/td&gt;&lt;td&gt;    8.1216µs&lt;/td&gt;&lt;td&gt; 1.41&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;cellsToLinkedMultiPolygonNestedDonuts&lt;/td&gt;&lt;td&gt;   45.9831µs&lt;/td&gt;&lt;td&gt;   34.7755µs&lt;/td&gt;&lt;td&gt; 1.32&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;polygonToCellsSF                     &lt;/td&gt;&lt;td&gt;  838.2980µs&lt;/td&gt;&lt;td&gt;  534.1300µs&lt;/td&gt;&lt;td&gt; 1.57&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;polygonToCellsAlameda                &lt;/td&gt;&lt;td&gt; 1183.9940µs&lt;/td&gt;&lt;td&gt;  656.2240µs&lt;/td&gt;&lt;td&gt; 1.80&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td&gt;polygonToCellsSouthernExpansion      &lt;/td&gt;&lt;td&gt;36224.0000µs&lt;/td&gt;&lt;td&gt;28038.4000µs&lt;/td&gt;&lt;td&gt; 1.29&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;
  Great! Seems like the benefits of &lt;code&gt;h3o&lt;/code&gt; weren't lost in the binding
  layer: we're still noticeably faster than &lt;code&gt;H3&lt;/code&gt;.
&lt;/p&gt;

&lt;h3&gt;On compatibility&lt;/h3&gt;

&lt;p&gt;
  While &lt;code&gt;h3oh3o&lt;/code&gt; covers the whole API and strives to be isofunctional
  to &lt;code&gt;H3&lt;/code&gt;, that's not always true when you look closely.
&lt;/p&gt;
&lt;p&gt;
  On the happy path, no worries: the only divergences are from things
  unspecified to begin with (e.g. the order of indexes returned by
  &lt;code&gt;compactCells&lt;/code&gt;).
  &lt;br/&gt;
  But on the error path, it's on a best-effort basis: &lt;code&gt;h3oh3o&lt;/code&gt; may
  detect more errors, returns a different error code, or simply return a
  sensible default value instead of an error.
  &lt;br/&gt;
  This is partly due to implementation details and partly due to conscious
  choice.
&lt;/p&gt;
&lt;p&gt;
  Given that error codes were added in &lt;code&gt;H3&lt;/code&gt; v4, which is relatively
  young, there is probably not a lot of code relying on precise error codes, but
  at least now you know.
&lt;/p&gt;

&lt;h3&gt;Example with h3-py&lt;/h3&gt;

&lt;p&gt;
  How difficult is it to port an &lt;code&gt;H3&lt;/code&gt; binding to &lt;code&gt;h3oh3o&lt;/code&gt;?
  &lt;br/&gt;
  Let's see with &lt;a href="https://github.com/uber/h3-py"&gt;h3-py&lt;/a&gt;!
&lt;/p&gt;
&lt;p&gt;
  A single patch is enough to get a working binding: simply replace the
  &lt;code&gt;h3&lt;/code&gt; submodule with the &lt;code&gt;h3oh3o&lt;/code&gt; one, update the header
  location and the names of a few constants, and voilà!
&lt;/p&gt;
    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="gd"&gt;--- a/.gitmodules
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/.gitmodules
&lt;/span&gt;&lt;span class="p"&gt;@@ -1,3 +1,3 @@&lt;/span&gt;
&lt;span class="gd"&gt;-[submodule "src/h3lib"]
-	path = src/h3lib
-	url = https://github.com/uber/h3
&lt;/span&gt;&lt;span class="gi"&gt;+[submodule "src/h3olib"]
+	path = src/h3olib
+	url = git@github.com:HydroniumLabs/h3oh3o.git
&lt;/span&gt;&lt;span class="gh"&gt;diff --git a/CMakeLists.txt b/CMakeLists.txt
&lt;/span&gt;&lt;span class="gd"&gt;--- a/CMakeLists.txt
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/CMakeLists.txt
&lt;/span&gt;&lt;span class="p"&gt;@@ -26,7 +26,7 @@&lt;/span&gt; turn_off(ENABLE_LINTING)

 # Build the core library as static
 set(BUILD_SHARED_LIBS OFF)
&lt;span class="gd"&gt;-add_subdirectory(src/h3lib)
&lt;/span&gt;&lt;span class="gi"&gt;+add_subdirectory(src/h3olib)
&lt;/span&gt;
 # Build the rest (other than the core library dependency) as shared
 set(BUILD_SHARED_LIBS ON)
&lt;span class="p"&gt;@@ -35,6 +35,6 @@&lt;/span&gt; add_subdirectory(src/h3)
 # Include built h3api.h for Cython API
 install(
     FILES
&lt;span class="gd"&gt;-        "${CMAKE_CURRENT_BINARY_DIR}/src/h3lib/src/h3lib/include/h3api.h"
&lt;/span&gt;&lt;span class="gi"&gt;+        "${CMAKE_CURRENT_BINARY_DIR}/src/h3olib/gen/h3api.h"
&lt;/span&gt;     DESTINATION
         src/h3/_cy)
&lt;span class="gh"&gt;diff --git a/src/h3/_cy/CMakeLists.txt b/src/h3/_cy/CMakeLists.txt
&lt;/span&gt;&lt;span class="gd"&gt;--- a/src/h3/_cy/CMakeLists.txt
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/src/h3/_cy/CMakeLists.txt
&lt;/span&gt;&lt;span class="p"&gt;@@ -11,7 +11,7 @@&lt;/span&gt; macro(add_cython_file filename)
     add_library(${filename} MODULE ${filename} ${LIB_SOURCE_FILES} ${CONFIGURED_API_HEADER})
     python_extension_module(${filename})
     set_property(TARGET ${filename} PROPERTY C_STANDARD 99)
&lt;span class="gd"&gt;-    target_link_libraries(${filename} h3)
&lt;/span&gt;&lt;span class="gi"&gt;+    target_link_libraries(${filename} h3oh3o::h3oh3o)
&lt;/span&gt;     install(TARGETS ${filename} LIBRARY DESTINATION src/h3/_cy)
 endmacro()

diff --git a/src/h3/_cy/h3lib.pxd b/src/h3/_cy/h3lib.pxd
&lt;span class="gd"&gt;--- a/src/h3/_cy/h3lib.pxd
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/src/h3/_cy/h3lib.pxd
&lt;/span&gt;&lt;span class="p"&gt;@@ -4,9 +4,9 @@&lt;/span&gt; from libc.stdint cimport uint32_t, uint64_t, int64_t
 ctypedef basestring H3str

 cdef extern from 'h3api.h':
&lt;span class="gd"&gt;-    cdef int H3_VERSION_MAJOR
-    cdef int H3_VERSION_MINOR
-    cdef int H3_VERSION_PATCH
&lt;/span&gt;&lt;span class="gi"&gt;+    cdef int H3O_VERSION_MAJOR
+    cdef int H3O_VERSION_MINOR
+    cdef int H3O_VERSION_PATCH
&lt;/span&gt;
     ctypedef uint64_t H3int 'H3Index'

diff --git a/src/h3/_cy/util.pyx b/src/h3/_cy/util.pyx
&lt;span class="gd"&gt;--- a/src/h3/_cy/util.pyx
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/src/h3/_cy/util.pyx
&lt;/span&gt;&lt;span class="p"&gt;@@ -28,9 +28,9 @@&lt;/span&gt; cdef (double, double) coord2deg(h3lib.LatLng c) nogil:

 cpdef basestring c_version():
     v = (
&lt;span class="gd"&gt;-        h3lib.H3_VERSION_MAJOR,
-        h3lib.H3_VERSION_MINOR,
-        h3lib.H3_VERSION_PATCH,
&lt;/span&gt;&lt;span class="gi"&gt;+        h3lib.H3O_VERSION_MAJOR,
+        h3lib.H3O_VERSION_MINOR,
+        h3lib.H3O_VERSION_PATCH,
&lt;/span&gt;     )

     return '{}.{}.{}'.format(*v)
&lt;span class="gh"&gt;diff --git a/src/h3lib b/src/h3lib
&lt;/span&gt;&lt;span class="p"&gt;deleted file mode 160000
&lt;/span&gt;&lt;span class="gd"&gt;--- a/src/h3lib
&lt;/span&gt;&lt;span class="gi"&gt;+++ /dev/null
&lt;/span&gt;&lt;span class="p"&gt;@@ -1 +0,0 @@&lt;/span&gt;
&lt;span class="gd"&gt;-Subproject commit 46a581c905b2747c861aa1683125276501f68a3b
&lt;/span&gt;&lt;span class="gh"&gt;diff --git a/src/h3olib b/src/h3olib
&lt;/span&gt;&lt;span class="p"&gt;new file mode 160000
&lt;/span&gt;&lt;span class="gd"&gt;--- /dev/null
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/src/h3olib
&lt;/span&gt;&lt;span class="p"&gt;@@ -0,0 +1 @@&lt;/span&gt;
&lt;span class="gi"&gt;+Subproject commit 66e352341384b6a67c8c47487febf123406e1f14
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Add another little patch to adapt the test suite to &lt;code&gt;h3oh3o&lt;/code&gt; and
  you get a working binding with a green test suite.
&lt;/p&gt;
    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="gd"&gt;--- a/tests/test_cells_and_edges.py
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/tests/test_cells_and_edges.py
&lt;/span&gt;&lt;span class="p"&gt;@@ -8,6 +8,8 @@&lt;/span&gt; from h3 import (
     H3ResMismatchError,
     H3CellInvalidError,
     H3NotNeighborsError,
&lt;span class="gi"&gt;+    H3DirEdgeInvalidError,
+    H3PentagonError,
&lt;/span&gt; )


&lt;span class="p"&gt;@@ -159,8 +161,9 @@&lt;/span&gt; def test_parent_err():
 def test_children():
     h = '8928308280fffff'

-    with pytest.raises(H3ResDomainError):
&lt;span class="gd"&gt;-        h3.cell_to_children(h, 8)
&lt;/span&gt;&lt;span class="gi"&gt;+    # H3O returns an empty set of children when resolution is coarser.
+    out = h3.cell_to_children(h, 8)
+    assert out == set()
&lt;/span&gt;
     # same resolution is set of just cell itself
     out = h3.cell_to_children(h, 9)
&lt;span class="p"&gt;@@ -442,10 +445,13 @@&lt;/span&gt; def test_edges():
     e_bad = '14928308280ffff1'
     assert not h3.is_valid_directed_edge(e_bad)

-    # note: won't raise an error on bad input
&lt;span class="gd"&gt;-    h3.get_directed_edge_origin(e_bad)
-    h3.get_directed_edge_destination(e_bad)
-    h3.directed_edge_to_cells(e_bad)
&lt;/span&gt;&lt;span class="gi"&gt;+    # Those are correctly caught by H3O
+    with pytest.raises(H3DirEdgeInvalidError):
+        h3.get_directed_edge_origin(e_bad)
+    with pytest.raises(H3DirEdgeInvalidError):
+        h3.get_directed_edge_destination(e_bad)
+    with pytest.raises(H3DirEdgeInvalidError):
+        h3.directed_edge_to_cells(e_bad)
&lt;/span&gt;

 def test_line():
&lt;span class="p"&gt;@@ -463,18 +469,19 @@&lt;/span&gt; def test_line():
     assert out == expected


&lt;span class="gd"&gt;-def test_versions():
-    from packaging.version import Version
-
-    v = h3.versions()
-
-    assert v['python'] == h3.__version__
-
-    v_c = Version(v['c'])
-    v_p = Version(v['python'])
-
-    # of X.Y.Z, X and Y must match
-    assert v_c.release[:2] == v_p.release[:2]
&lt;/span&gt;&lt;span class="gi"&gt;+# No longer true with H3O since numbering goes back to 0.1.0
+#def test_versions():
+#    from packaging.version import Version
+#
+#    v = h3.versions()
+#
+#    assert v['python'] == h3.__version__
+#
+#    v_c = Version(v['c'])
+#    v_p = Version(v['python'])
+#
+#    # of X.Y.Z, X and Y must match
+#    assert v_c.release[:2] == v_p.release[:2]
&lt;/span&gt;

 def test_str_int_convert():
&lt;span class="p"&gt;@@ -615,7 +622,7 @@&lt;/span&gt; def test_from_local_ij_error():

     baddies = [(1, -1), (-1, 1), (-1, -1)]
     for i, j in baddies:
&lt;span class="gd"&gt;-        with pytest.raises(H3FailedError):
&lt;/span&gt;&lt;span class="gi"&gt;+        with pytest.raises((H3PentagonError, H3FailedError)):
&lt;/span&gt;             h3.local_ij_to_cell(h, i, j)

     # inverting output should give good data
&lt;span class="gh"&gt;diff --git a/tests/test_h3.py b/tests/test_h3.py
&lt;/span&gt;&lt;span class="gd"&gt;--- a/tests/test_h3.py
&lt;/span&gt;&lt;span class="gi"&gt;+++ b/tests/test_h3.py
&lt;/span&gt;&lt;span class="p"&gt;@@ -471,9 +471,8 @@&lt;/span&gt; def test_compact_cells_and_uncompact_cells_nothing():

 def test_uncompact_cells_error():
     hexagons = [h3.latlng_to_cell(37, -122, 10)]
&lt;span class="gd"&gt;-
-    with pytest.raises(Exception):
-        h3.uncompact_cells(hexagons, 5)
&lt;/span&gt;&lt;span class="gi"&gt;+    # H3O return an empty set when unpacking to a coarser resolution.
+    h3.uncompact_cells(hexagons, 5) == set()
&lt;/span&gt;

 def test_compact_cells_malformed_input():
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;

&lt;p&gt;You can now use &lt;code&gt;h3o&lt;/code&gt; in Python.&lt;/p&gt;

&lt;h2&gt;h3o-cli: the H3 Swiss Army knife CLI&lt;/h2&gt;
&lt;p&gt;
  &lt;a href="https://github.com/HydroniumLabs/h3o-cli"&gt;h3o-cli&lt;/a&gt; brings the
  power of &lt;code&gt;h3o&lt;/code&gt; to your fingertips. Its main purpose is to replace
  the one-shot scripts you would write to quickly test or verify something
  (e.g. convert a shape to indexes, describe a cell index, print resolution
  statistics, …)
&lt;/p&gt;
&lt;p&gt;
  Each subcommand has up to four output formats:
  &lt;ul&gt;
    &lt;li&gt;text: for human consumption or commands pipelines&lt;/li&gt;
    &lt;li&gt;JSON: for program consumption and scripting (easier parsing)&lt;/li&gt;
    &lt;li&gt;
      GeoJSON: for visualization (e.g. using
      &lt;a href="https://geojson.io"&gt;geojson.io&lt;/a&gt;)
    &lt;/li&gt;
    &lt;li&gt;KML: for vizualization too&lt;/li&gt;
  &lt;/ul&gt;
&lt;/p&gt;
&lt;p&gt;
  Note that the CLI is built with composition in mind, as such the output of
  some subcommands can be piped into other subcommands, allowing to build
  complex processing pipelines easily.
  &lt;br/&gt;
  For instance, the following command computes the coverage of Paris, from a
  GeoJSON file, and compacts then compresses the resulting set into an output
  file.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;h3o-cli geomToCells -r 11 -f geojson &amp;lt; paris.geojson \
    | h3o-cli compact \
    | h3o-cli compress &amp;gt; cells.thc
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  The CLI doesn't cover the whole API yet, it's currently focused on the subset
  I found myself using the most but I plan to enrich it as time pass.
&lt;/p&gt;

&lt;h2&gt;thc: a compression scheme tailored for H3&lt;/h2&gt;

&lt;p&gt;
  &lt;a href="https://github.com/HydroniumLabs/thc"&gt;thc (The H3 Compressor)&lt;/a&gt;
  is a library that provides compression algorithms tailored for H3.
&lt;/p&gt;
&lt;p&gt;
  The first (and only for now) algorithm provided is CHT (Compressed H3 Tree)
  which is optimized for compression size. The main use cases would be on-disk
  storage or transfers across the network.
&lt;/p&gt;
&lt;p&gt;
  The &lt;code&gt;H3&lt;/code&gt; library already provides a compaction algorithm, but it
  has some limitations:
  &lt;ul&gt;
    &lt;li&gt;only works on homogeneous (in terms of resolutions) sets&lt;/li&gt;
    &lt;li&gt;
      doesn't compress the index (an index is still 64-bit), only reduces their
      number
    &lt;/li&gt;
    &lt;li&gt;
      is almost useless on input sets with (almost) no clusters (e.g. paths)
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/p&gt;
&lt;p&gt;
  CHT addresses those weaknesses:
  &lt;ul&gt;
    &lt;li&gt;can take heterogeneous sets as input&lt;/li&gt;
    &lt;li&gt;
      indexes are compressed, at best it goes from 64 bits/index to 2.3
      bits/index
    &lt;/li&gt;
    &lt;li&gt;
      cluster-less input sets can also be compressed (albeit less efficiently
      since there is less information redundancy, but still usually goes down
      from 64-bit/index to 6.25 bits/index).
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/p&gt;
&lt;p&gt;
  CHT accomplishes this by viewing the H3 system as a gigantic tree, where
  resolutions are levels and cell indexes encode paths into this tree. A set of
  cell indexes is equivalent to a set of paths, that once grouped together forms
  a subtree. This subtree is then encoded in a compact way.
  &lt;br/&gt;
  The curious reader can inspect the source code at
  &lt;a href="https://github.com/HydroniumLabs/thc/blob/master/src/cht.rs"&gt;cht.rs&lt;/a&gt;,
  where the implementation details are documented, with step-by-step examples.
&lt;/p&gt;

&lt;h3&gt;Benchmark&lt;/h3&gt;

&lt;h4&gt;Dense set: Paris&lt;/h4&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/paris.jpg" class="centered" title="The shape of Paris" alt="The shape of Paris"&gt;
&lt;/p&gt;
&lt;p&gt;
  At resolution 11, Paris contains 54,812 cell indexes.  At 64-bit per index,
  this represents ~438KB (438,496 bytes).
&lt;/p&gt;
&lt;p&gt;
  If we compress these indexes using CHT, we get a payload ~27x smaller than the
  original size (16,330 bytes, i.e. ~16KB) meaning that each index is encoded on
  ~2.38 bits.
&lt;/p&gt;
&lt;p&gt;
  If we compact these indexes, we get a similar result: a payload ~27x smaller
  (16,192 bytes, a tad bit smaller than THC but still ~16KB). But the indexes
  are still encoded on 64 bits, we've greatly reduced their number (from 54,812
  to 2,024) instead of compressing them.
&lt;/p&gt;
&lt;p&gt;
  Remember that CHT also works on heterogeneous index sets, like the one
  produced by the compaction algorithm: what if we try to compress the compacted
  set?
  &lt;br/&gt;
  In that case, we get a payload 17x smaller than the compacted one, with the
  2,024 indexes being represented by 933 bytes (i.e. ~3.69 bits/index). Even
  though the compression is less efficient (3.69 vs 2.38), since we have a lot
  fewer indexes the end result is a lot better than compressing the uncompacted
  set.
&lt;/p&gt;
&lt;p&gt;
  In the end, we went from a ~438KB payload to one under 1KB (~x469 smaller),
  effectively encoding 54,812 indexes on 933 bytes (equivalent to ~0.14
  bits/index).
&lt;/p&gt;
&lt;p&gt;
  Results are even more impressive applied at the country level (only
  considering mainland France here): 267,532,208 indexes occupying ~2.14GB
  (2,140,257,664 bytes) are reduced to a payload of ~103KB (103,348 bytes) by
  &lt;code&gt;compact-then-compress&lt;/code&gt;, which is  20k times smaller  (equivalent
  to ~0.003 bits/index) than the starting point.
&lt;/p&gt;

&lt;h4&gt;Sparse set: bikeways&lt;/h4&gt;
&lt;p&gt;
  Ok, that was the easy case: what about index sets representing things like
  paths? How do we behave with this class of input?
  &lt;br/&gt;
  Let's find out by using a (non-exhaustive) map of France's bikeways as input!
&lt;/p&gt;
&lt;p&gt;
  &lt;img src="/static/images/h3o/bikeways.jpg" class="centered" title="Bikeways in France" alt="Bikeways in France"&gt;
&lt;/p&gt;
&lt;p&gt;
  At resolution 11 we have 690,451 indexes which represents a 5.52MB payload
  (5,523,608 bytes).
&lt;/p&gt;
&lt;p&gt;
  If we compact this index set, we don't gain much: we get a set of 689,971 (a
  difference of 480 indexes only), which is not noticeably smaller (5,519,768
  bytes, which is still 5.52MB).
&lt;/p&gt;
&lt;p&gt;
  On the other hand, if the compress this index set we're down to ~539KB
  (539,405 bytes), which is 10x smaller (each index is encoded on ~6.25 bits).
&lt;/p&gt;
&lt;p&gt;
  While not as impressive as the previous test, which is not surprising as we're
  kinda comparing best case vs worst case here, it's still an appreciable gain
  (especially compared to the uselessness of the compaction on that kind of
  index set).
&lt;/p&gt;

&lt;h2&gt;What's next&lt;/h2&gt;
&lt;p&gt;
  Even though the h3o API is expected to be close to its final state, I won't
  rush for the 1.0 just yet. I first want to build more projects on top of it
  to detect any rough edges that would need some adjustments.
&lt;/p&gt;
&lt;p&gt;
  Short term, I would need to catch up with the soon-to-be-released
  &lt;code&gt;H3&lt;/code&gt; 4.1.
&lt;/p&gt;
&lt;p&gt;
  Medium-term, I plan to continue my work on a compact and efficient in-memory
  data structure for indexes set of homogeneous resolution. Already have a very
  promising first draft locally, but it still needs to be refined to reach a
  releasable state.
  &lt;br/&gt;
  Also fix the functions that are still slower than &lt;code&gt;H3&lt;/code&gt;.
&lt;/p&gt;
&lt;p&gt;
  Long term, will work on more bindings: a better C one and also dedicated
  bindings for other languages (as mentioned above).
&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:grim7reaper.github.io,2019-12-06:/blog/2019/12/06/python-optimisation-et-couverture-de-code/</id>
    <title type="html">Python : optimisation et couverture de code</title>
    <published>2019-12-06T00:00:00Z</published>
    <updated>2019-12-06T00:00:00Z</updated>
    <link rel="alternate" href="https://grim7reaper.github.io/blog/2019/12/06/python-optimisation-et-couverture-de-code/" type="text/html"/>
    <content type="html">&lt;p&gt;
  Il est courant de vérifier si nos tests couvrent bien notre code, et en Python
  on utilise généralement
  &lt;a href="https://coverage.readthedocs.io/en/latest/"&gt;coverage&lt;/a&gt; pour ça.
&lt;/p&gt;

&lt;p&gt;
  Cependant, il faut savoir que les optimisations de l’interpréteur peuvent
  interférer, même si elles n’ont pas été activées explicitement via
  l’option &lt;code&gt;-O&lt;/code&gt;.
&lt;/p&gt;



&lt;h2&gt;Démonstration&lt;/h2&gt;

&lt;p&gt;
  Le code suivant est une version simplifiée d’un code plus complexe où j’ai
  rencontré ce problème&lt;sup id="fnref:1"&gt;&lt;a href="#fn:1"&gt;1&lt;/a&gt;&lt;/sup&gt; :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Exemple minimal reproduisant le problème&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="c1"&gt;#!/usr/bin/env python
# coding: utf-8
&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lst&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;lst&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="nb"&gt;Exception&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'error'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'x is odd'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;continue&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'nothing to do'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Si l’on exécute ce code, avec &lt;code&gt;coverage run foo.py&lt;/code&gt; on obtient la
  trace suivante :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;1
x is odd
nothing to do
2
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;On constate que chaque ligne est exécutée au moins une fois :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;code&gt;1&lt;/code&gt; : &lt;code&gt;print&lt;/code&gt; de la ligne 6.
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;x is odd&lt;/code&gt; : &lt;code&gt;print&lt;/code&gt; de la ligne 11, ce qui signifie
    que l’on est passé par le &lt;code&gt;if&lt;/code&gt; de ligne 8 et que l’on a levé une
    exception à la ligne 9.
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;nothing to do&lt;/code&gt; : &lt;code&gt;print&lt;/code&gt; de la ligne 14.
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;2&lt;/code&gt; : &lt;code&gt;print&lt;/code&gt; de la ligne 6, étant donné qu’il n’y a
    pas de « nothing to do » on en conclut que l’on est passé par le
    &lt;code&gt;continue&lt;/code&gt; de la ligne 13 (et que l’on a sauté
    le &lt;code&gt;print&lt;/code&gt; de la ligne 14).
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Cependant, si l’on exécute &lt;code&gt;coverage report -m&lt;/code&gt; on obtient le
  résultat suivant :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;Name     Stmts   Miss  Cover   Missing
--------------------------------------
foo.py      11      1    91%   13
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  D’après &lt;code&gt;coverage&lt;/code&gt;, nous ne sommes pas passé par la ligne 13 !
  Impossible, car si c’était le cas, nous aurions vu « nothing to do » après le
  « 2 ».
&lt;/p&gt;

&lt;p&gt;
  Pour aller encore plus loin dans le « fun », on peut modifier le code en
  déplaçant le &lt;code&gt;continue&lt;/code&gt; à l’intérieur du &lt;code&gt;try&lt;/code&gt;, après la
  levée d’exception :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Version alternative&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="c1"&gt;#!/usr/bin/env python
# coding: utf-8
&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lst&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;lst&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;x&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;x&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="nb"&gt;Exception&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'meh!'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;continue&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'x is odd'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;'nothing to do'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Nous avons le même comportement, car &lt;code&gt;coverage run foo.py&lt;/code&gt; produit
  exactement la même trace :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;1
x is odd
nothing to do
2
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Par contre, cette fois ci &lt;code&gt;coverage&lt;/code&gt; confirme bien que chaque ligne
  a été exécutée :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;Name     Stmts   Miss  Cover   Missing
--------------------------------------
ok2.py      11      0   100%
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;Étrange n’est-ce pas ?&lt;/p&gt;



&lt;h2&gt;Sous le capot&lt;/h2&gt;

&lt;p&gt;
  Dans ce genre de cas, il peut être intéressant de voir le &lt;em&gt;bytecode&lt;/em&gt;
  généré par l’interpréteur. Pour ce faire, nous allons utiliser le
  module &lt;code&gt;dis&lt;/code&gt; (que j’avais déjà
  utilisé &lt;a href="/blog/2013/11/10/crackme-python/"&gt;ici&lt;/a&gt;) afin de comparer
  le &lt;em&gt;bytecode&lt;/em&gt; des deux fonctions et essayer de comprendre l’origine de
  cette différence.
&lt;/p&gt;

&lt;h3&gt;Version qui fonctionne&lt;/h3&gt;

&lt;p&gt;On va commencer par analyser la version qui fonctionne.&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;  5           0 SETUP_LOOP              72 (to 74)
              2 LOAD_FAST                0 (lst)
              4 GET_ITER
        &amp;gt;&amp;gt;    6 FOR_ITER                64 (to 72)
              8 STORE_FAST               1 (x)

  6          10 LOAD_GLOBAL              0 (print)
             12 LOAD_FAST                1 (x)
             14 CALL_FUNCTION            1
             16 POP_TOP

  7          18 SETUP_EXCEPT            22 (to 42)

  8          20 LOAD_FAST                1 (x)
             22 LOAD_CONST               1 (1)
             24 BINARY_AND
             26 POP_JUMP_IF_FALSE       36

  9          28 LOAD_GLOBAL              1 (Exception)
             30 LOAD_CONST               2 ('meh!')
             32 CALL_FUNCTION            1
             34 RAISE_VARARGS            1

 10     &amp;gt;&amp;gt;   36 CONTINUE_LOOP            6
             38 POP_BLOCK
             40 JUMP_FORWARD            20 (to 62)

 11     &amp;gt;&amp;gt;   42 POP_TOP
             44 POP_TOP
             46 POP_TOP

 12          48 LOAD_GLOBAL              0 (print)
             50 LOAD_CONST               3 ('x is odd')
             52 CALL_FUNCTION            1
             54 POP_TOP
             56 POP_EXCEPT
             58 JUMP_FORWARD             2 (to 62)
             60 END_FINALLY

 13     &amp;gt;&amp;gt;   62 LOAD_GLOBAL              0 (print)
             64 LOAD_CONST               4 ('nothing to do')
             66 CALL_FUNCTION            1
             68 POP_TOP
             70 JUMP_ABSOLUTE            6
        &amp;gt;&amp;gt;   72 POP_BLOCK
        &amp;gt;&amp;gt;   74 LOAD_CONST               0 (None)
             76 RETURN_VALUE
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Petite parenthèse sur le format de sortie de &lt;code&gt;dis&lt;/code&gt; :
&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    première colonne : numéro de ligne pour la première instruction de chaque
    ligne (une ligne de code Python étant composée de plusieurs instructions).
  &lt;/li&gt;
  &lt;li&gt;
    deuxième colonne : &lt;code&gt;--&gt;&lt;/code&gt; pour indiquer l’instruction en cours
    d’exécution.
  &lt;/li&gt;
  &lt;li&gt;
    troisième colonne : &lt;code&gt;&gt;&gt;&lt;/code&gt; pour indiquer que l’instruction est une
    cible de saut (&lt;em&gt;i.e.&lt;/em&gt; une autre instruction peut sauter à cet
    endroit).
  &lt;/li&gt;
  &lt;li&gt;
    quatrième colonne : &lt;em&gt;offset&lt;/em&gt; de l’instruction (souvent utilisé comme
    cible de saut).
  &lt;/li&gt;
  &lt;li&gt;
    cinquième colonne : nom de l’instruction.
  &lt;/li&gt;
  &lt;li&gt;
    sixième colonne : arguments de l’instruction.
  &lt;/li&gt;
  &lt;li&gt;
    septième colonne : informations supplémentaires sur les arguments.
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;
  Sachant cela, on voit bien que notre &lt;code&gt;continue&lt;/code&gt; ligne 10 est
  traduit en un &lt;code&gt;CONTINUE_LOOP&lt;/code&gt; (et deux autres instructions pour
  sortir du &lt;code&gt;try&lt;/code&gt; et retourner au début de la boucle).
&lt;/p&gt;

&lt;h3&gt;Version problèmatique&lt;/h3&gt;

&lt;p&gt;
  Maintenant, voyons voir le &lt;em&gt;bytecode&lt;/em&gt; de la version
  problèmatique :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;  5           0 SETUP_LOOP              72 (to 74)
              2 LOAD_FAST                0 (lst)
              4 GET_ITER
        &amp;gt;&amp;gt;    6 FOR_ITER                64 (to 72)
              8 STORE_FAST               1 (x)

  6          10 LOAD_GLOBAL              0 (print)
             12 LOAD_FAST                1 (x)
             14 CALL_FUNCTION            1
             16 POP_TOP

  7          18 SETUP_EXCEPT            20 (to 40)

  8          20 LOAD_FAST                1 (x)
             22 LOAD_CONST               1 (1)
             24 BINARY_AND
             26 POP_JUMP_IF_FALSE       36

  9          28 LOAD_GLOBAL              1 (Exception)
             30 LOAD_CONST               2 ('meh!')
             32 CALL_FUNCTION            1
             34 RAISE_VARARGS            1
        &amp;gt;&amp;gt;   36 POP_BLOCK
             38 JUMP_ABSOLUTE            6

 10     &amp;gt;&amp;gt;   40 POP_TOP
             42 POP_TOP
             44 POP_TOP

 11          46 LOAD_GLOBAL              0 (print)
             48 LOAD_CONST               3 ('x is odd')
             50 CALL_FUNCTION            1
             52 POP_TOP
             54 POP_EXCEPT
             56 JUMP_FORWARD             4 (to 62)
             58 END_FINALLY

 13          60 JUMP_ABSOLUTE            6

 14     &amp;gt;&amp;gt;   62 LOAD_GLOBAL              0 (print)
             64 LOAD_CONST               4 ('nothing to do')
             66 CALL_FUNCTION            1
             68 POP_TOP
             70 JUMP_ABSOLUTE            6
        &amp;gt;&amp;gt;   72 POP_BLOCK
        &amp;gt;&amp;gt;   74 LOAD_CONST               0 (None)
             76 RETURN_VALUE
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  La première chose que l’on remarque, c’est l’absence
  d’instruction &lt;code&gt;CONTINUE_LOOP&lt;/code&gt; : à la place nous avons
  un &lt;code&gt;JUMP_ABSOLUTE&lt;/code&gt; à la ligne 13.
&lt;/p&gt;

&lt;p&gt;
  La seconde chose que l’on remarque c’est que cette instruction
  &lt;code&gt;JUMP_ABSOLUTE&lt;/code&gt; n’est pas atteignable :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    si la condition du &lt;code&gt;if&lt;/code&gt; est fausse (position 26), on saute à la
    position 36 qui fait un saut à la position 6.
  &lt;/li&gt;
  &lt;li&gt;
    si la condition du &lt;code&gt;if&lt;/code&gt; est vraie, on va lancer une exception et
    sauter à la position 40 (cf. le &lt;code&gt;SETUP_EXCEPT&lt;/code&gt; de la position
    18), puis exécuter les instructions jusqu’au saut de la position 56 qui nous
    amène à la position 62.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Dans les deux cas, on ne passe pas par la position 60, et comme aucune
  instruction ne saute à cette position (elle n’est pas marqué
  avec &lt;code&gt;&gt;&gt;&lt;/code&gt;) et bien cette instruction n’est jamais exécutée.
&lt;/p&gt;



&lt;h3&gt;Hypothèse&lt;/h3&gt;

&lt;p&gt;
  Si l’on devait générer le code nous-même en faisant du « mot à mot », on
  produirait probablement la séquence suivante :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    on commence par traduire le &lt;code&gt;if&lt;/code&gt; de la ligne 8 en utilisant
    un &lt;code&gt;POP_JUMP_IF_FALSE&lt;/code&gt; qui saute à la fin du bloc
    &lt;code&gt;try&lt;/code&gt; sur un &lt;code&gt;POP_BLOCK&lt;/code&gt; (position 36) pour sortir du
    bloc.
  &lt;/li&gt;
  &lt;li&gt;
    à la suite de ce &lt;code&gt;POP_BLOCK&lt;/code&gt; on ajoute un saut jusqu’au
    &lt;code&gt;continue&lt;/code&gt; de la ligne 13/position 60 (probablement en utilisant
    un &lt;code&gt;JUMP_FORWARD&lt;/code&gt;).
  &lt;/li&gt;
  &lt;li&gt;
    enfin, le &lt;code&gt;continue&lt;/code&gt; de la ligne 13 est représenté par
    un &lt;code&gt;CONTINUE_LOOP&lt;/code&gt; qui saute au début de la boucle à la position
    6 (comme dans l’exemple qui fonctionne).
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Maintenant, si on prend un peu de recul et que l’on décrit les choses de
  manière plus abstraite cela donne :
&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    saute vers A si la condition est fausse (&lt;code&gt;POP_JUMP_IF_FALSE&lt;/code&gt; vers
    le &lt;code&gt;POP_BLOCK&lt;/code&gt;).
  &lt;/li&gt;
  &lt;li&gt;
    saute vers B (&lt;code&gt;JUMP_FORWARD&lt;/code&gt; vers le &lt;code&gt;continue&lt;/code&gt;).
  &lt;/li&gt;
  &lt;li&gt;
    saute vers C (&lt;code&gt;CONTINUE_LOOP&lt;/code&gt; vers le début de la boucle).
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;
  On remarque que les deux dernières étapes sont des sauts inconditionnels, par
  conséquent l’étape 2 est superflue : on peut sauter de A vers C directement.
&lt;/p&gt;

&lt;p&gt;
  On peut donc raisonnablement penser que CPython sait reconnaître ce motif de
  « deux sauts inconditionnels consécutifs » et le remplace par un unique saut
  vers la destination finale.
&lt;/p&gt;

&lt;p&gt;
  Ce genre d’optimisations où l’on remplace une suite
  d’instructions &lt;code&gt;A&lt;/code&gt; par une autre suite
  d’instructions &lt;code&gt;B&lt;/code&gt; fonctionnellement équivalente (mais plus
  efficace) est très commune et s’appelle une
  &lt;a href="https://en.wikipedia.org/wiki/Peephole_optimization"&gt;peephole optimization&lt;/a&gt;.
&lt;/p&gt;

&lt;p&gt;
  Et c’est bien ce que semble faire CPython en sautant directement au début de
  la boucle depuis la fin du bloc &lt;code&gt;try&lt;/code&gt;, ignorant totalement notre
  bloc &lt;code&gt;else&lt;/code&gt; au passage (qui ne contient rien d’autre qu’un saut
  inconditionnel).
&lt;/p&gt;

&lt;p&gt;
  Cela semble être confirmé par le fait que si l’on rajoute
  un &lt;code&gt;print&lt;/code&gt; dans le &lt;code&gt;else&lt;/code&gt; (avant
  le &lt;code&gt;continue&lt;/code&gt;) alors le bloc &lt;code&gt;else&lt;/code&gt; et
  son &lt;code&gt;continue&lt;/code&gt; sont maintenant exécutés. En effet, dans le cas
  contraire le &lt;code&gt;print&lt;/code&gt; ne serait pas exécuté et cela provoquerait une
  différence de comportement observable qui rendrait l’optimisation caduque.
&lt;/p&gt;



&lt;h3&gt;Confirmation de l’hypothèse&lt;/h3&gt;

&lt;p&gt;
  Bon, on a maintenant une hypothèse plutôt solide, et après quelques recherches
  on tombe sur :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;a href="https://github.com/pytest-dev/pytest-cov/issues/167"&gt;ce rapport de bogue&lt;/a&gt;
    chez &lt;code&gt;pytest-cov&lt;/code&gt; qui nous apprend que la
    bibliothèque &lt;code&gt;coverage&lt;/code&gt; serait à l’origine du problème.
  &lt;/li&gt;
  &lt;li&gt;
    il s’avère que le lien donné pointe sur
    &lt;a href="https://github.com/nedbat/coveragepy/issues/594"&gt;un doublon&lt;/a&gt;.
  &lt;/li&gt;
  &lt;li&gt;
    en remontant au
    &lt;a href="https://github.com/nedbat/coveragepy/issues/198"&gt;bogue d’origine&lt;/a&gt;
    (on remarquera le titre qui mentionne &lt;code&gt;continue&lt;/code&gt;) on découvre que
    le problème ne vient pas de &lt;code&gt;coverage&lt;/code&gt; lui-même mais de
    l’interpréteur Python (CPython en l’occurrence) qui est capable de remplacer
    un saut vers un &lt;code&gt;continue&lt;/code&gt; par un saut vers le début de la boucle
    directement (au passage, on y apprend aussi que cette optimisation est
    &lt;strong&gt;toujours&lt;/strong&gt; activée).
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Pour ceux qui veulent suivre l’évolution de ce problème,
  &lt;a href="https://bugs.python.org/issue2506"&gt;un bogue à été ouvert&lt;/a&gt; pour
  l’interpréteur.
&lt;/p&gt;

&lt;p&gt;
  Cela vient donc confirmer notre hypothèse : l’optimiseur intervient sur les
  instructions générées, ce qui affecte la couverture du code source.
&lt;/p&gt;



&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;
  La première leçon que l’on peut en tirer c’est que le code que l’on voit ne
  correspond pas forcément au code qui est exécuté. C’est bien connu dans les
  langages tel que le C par exemple, mais c’est plus surprenant en Python.
&lt;/p&gt;

&lt;p&gt;
  Deuxième point important : ce problème est simple à résoudre car « il
  suffit de » réécrire le code en utilisant la version « qui fonctionne », et
  c’est même plutôt bénéfique étant donné qu’elle est aussi plus lisible que le
  code d’origine. En effet, l’utilisation du &lt;code&gt;else&lt;/code&gt; dans une
  construction &lt;code&gt;try/except&lt;/code&gt; est spécifique à Python et donc
  probablement méconnue.
&lt;/p&gt;

&lt;p&gt;
  Au passage, ces constructions « bizarres » à base
  de &lt;code&gt;try&lt;/code&gt;, &lt;code&gt;else&lt;/code&gt; et &lt;code&gt;continue&lt;/code&gt;, en plus
  d’être parfois difficile à déchiffrer, ne sont pas toujours bien supportées :
  pendant longtemps il a été impossible d’avoir un
  &lt;code&gt;continue&lt;/code&gt; à l’intérieur d’un bloc &lt;code&gt;try&lt;/code&gt; (c’est
  maintenant possible). Et aujourd’hui
  encore&lt;sup id="fnref:2"&gt;&lt;a href="#fn:2"&gt;2&lt;/a&gt;&lt;/sup&gt; il n’est pas possible
  d’avoir un &lt;code&gt;continue&lt;/code&gt; dans un bloc &lt;code&gt;finally&lt;/code&gt; : c’est une
  erreur de syntaxe !
&lt;/p&gt;

&lt;p&gt;
  En conclusion, il vaut mieux écrire du code simple et quand quelque chose de
  bizarre se produit il ne faut pas hésiter à regarder sous le capot pour en
  comprendre les raisons.
&lt;/p&gt;



&lt;div class="footnotes"&gt;
  &lt;hr class="weak-hr" /&gt;
  &lt;ol&gt;
    &lt;li id="fn:1"&gt;
      &lt;p&gt;
        le code du &lt;code&gt;else&lt;/code&gt; dans la construction
        &lt;code&gt;try&lt;/code&gt;/&lt;code&gt;except&lt;/code&gt;/&lt;code&gt;else&lt;/code&gt; est exécuté
        seulement si aucune exception n’a été levée à l‘intérieur du
        &lt;code&gt;try&lt;/code&gt;.&lt;a href="#fnref:1"&gt;↩&lt;/a&gt;
      &lt;/p&gt;
    &lt;/li&gt;
    &lt;li id="fn:2"&gt;
      &lt;p&gt;
        c’est maintenant possible en
        &lt;a href="https://docs.python.org/3.8/whatsnew/3.8.html#other-language-changes"&gt;Python 3.8&lt;/a&gt;,
        qui est sorti entre le début de la rédaction de cet article et sa
        publication.&lt;a href="#fnref:2"&gt;↩&lt;/a&gt;
      &lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;
</content>
  </entry>
  <entry>
    <id>tag:grim7reaper.github.io,2019-11-17:/blog/2019/11/17/migration-du-blog-sur-nanoc/</id>
    <title type="html">Migration du blog sur Nanoc</title>
    <published>2019-11-17T00:00:00Z</published>
    <updated>2019-11-17T00:00:00Z</updated>
    <link rel="alternate" href="https://grim7reaper.github.io/blog/2019/11/17/migration-du-blog-sur-nanoc/" type="text/html"/>
    <content type="html">&lt;p&gt;
  Comme vous l’avez très certainement remarqué, le blog a changé d’apparence :
  c’est dû à la migration du blog sur Nanoc.
&lt;/p&gt;



&lt;h2&gt;Pourquoi cette migration ?&lt;/h2&gt;

&lt;p&gt;Plusieurs raisons m’ont donné envie de quitter Octopress :&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;
    la façon dont fonctionne Octopress 2 est « perfectible™ » : pour utiliser
    Octopress il faut cloner le dépôt Git, puis créer son blog dans ce dépôt (ce
    qui peut générer des conflits lorsque l’on souhaite mettre à jour Octopress
    avec un &lt;code&gt;git pull&lt;/code&gt;). C’est d’ailleurs l’un des défauts qui a
    amené l’auteur à créer
    &lt;a href="https://octopress.org/2015/01/15/octopress-3.0-is-coming/"&gt;Octopress 3&lt;/a&gt;.
  &lt;/li&gt;
  &lt;li&gt;
    Octopress lui-même semble plus ou moins mort : Octopress 2 n’est plus
    développé et le développement d’Octopress 3 semble à l’arrêt. Je n’ai pas
    vraiment envie de construire mon blog sur un &lt;em&gt;framework&lt;/em&gt;
    potentiellement non-maintenu.
  &lt;/li&gt;
  &lt;li&gt;
    Octopress est livré avec beaucoup de fonctionnalités par défaut, c’est
    très pratique pour débuter et ça m’a bien aidé au début. Mais maintenant
    que je veux avoir un contrôle plus fin et plus de compréhension sur la
    tambouille interne ce côté « magique » deviens un désavantage.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Quand j’ai décidé de migrer, en août 2017 (oui, il y a eu un &lt;em&gt;looooong&lt;/em&gt;
  délai entre l’envie et la réalisation concrète), j’ai demandé à
  &lt;a href="https://kaworu.ch/about/"&gt;kAworu&lt;/a&gt; ce qu’il utilisait et la réponse
  fut &lt;a href="https://nanoc.app/"&gt;Nanoc&lt;/a&gt;. Après avoir fait quelques
  recherches dessus, j’ai décidé d’utiliser Nanoc moi aussi.
  &lt;br /&gt;
  Voici quelques points qui ont fait pencher la balance en sa faveur :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;c’est du Ruby, et le Ruby c’est fun, puissant et simple à utiliser.&lt;/li&gt;
  &lt;li&gt;pas de magie par défaut, il faut vraiment faire les choses soit-même.&lt;/li&gt;
  &lt;li&gt;&lt;a href="https://nanoc.app/about/"&gt;la documentation&lt;/a&gt; est bonne.&lt;/li&gt;
  &lt;li&gt;et surtout c’est testé et approuvé par kAworu ! :p&lt;/li&gt;
&lt;/ul&gt;



&lt;h2&gt;Changements visibles&lt;/h2&gt;

&lt;p&gt;
  Le changement le plus visible est bien évidemment le thème du blog : j’utilise
  maintenant une CSS faite maison. Cependant, étant donné mes connaissances
  limitées dans ce domaine, je suis parti sur un thème très simple. Malgré cela,
  j’ai essayé de rendre le résultat &lt;em&gt;responsive&lt;/em&gt; (du moins en partie…).
  &lt;br /&gt;
  Notez également que, pour épargner vos yeux (mon mauvais goût en matière
  d’associations de couleurs étant légendaire), je me suis limité aux couleurs
  de &lt;a href="https://ethanschoonover.com/solarized/"&gt;Solarized&lt;/a&gt;.
&lt;/p&gt;

&lt;p&gt;
  Au niveau de la structure, là aussi j’ai beaucoup simplifié :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    la page d’accueil liste maintenant tous les articles publiés (elle remplace
    donc la page d’archives, qui a été supprimée) : cela permet d’avoir une vue
    d’ensemble du contenu du blog au premier coup d’œil.
  &lt;/li&gt;
  &lt;li&gt;
    pas de pagination (devenu inutile avec la nouvelle page d’accueil).
  &lt;/li&gt;
  &lt;li&gt;
    utilisation d’une unique page pour lister les articles classés par
    catégories. Je reviendrais peut-être à une page par catégorie (comme c’était
    le cas avant) quand j’aurai plus d’articles.
  &lt;/li&gt;
  &lt;li&gt;
    chaque article possède maintenant une courte description qui est affiché sur
    la page d’accueil et la page des catégories.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;En ce qui concerne les changements moins visibles :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    remplacement des liens &lt;code&gt;http&lt;/code&gt; par &lt;code&gt;https&lt;/code&gt; quand c’est
    possible (de nos jours, la plupart des sites sont accessible en HTTPS, ce
    qui n’était pas forcément le cas lors de la rédaction de certains articles).
  &lt;/li&gt;
  &lt;li&gt;
    réparation des liens cassés, en utilisant
    &lt;a href="https://web.archive.org/"&gt;archive.org&lt;/a&gt; si nécessaire.
  &lt;/li&gt;
  &lt;li&gt;
    nouvelle favicon (faite maison, avec mes maigres capacités artistiques).
  &lt;/li&gt;
  &lt;li&gt;
    suppression de tout le JavaScript (il n’y en avait pas beaucoup à la base,
    mais maintenant il n’y en a plus du tout : 100% &lt;em&gt;JS free&lt;/em&gt;).
  &lt;/li&gt;
&lt;/ul&gt;



&lt;h2&gt;Sous le capot&lt;/h2&gt;

&lt;h3&gt;Le langage source&lt;/h3&gt;

&lt;p&gt;
  Le premier changement interne est le passage de Markdown à
  &lt;a href="https://en.wikipedia.org/wiki/ERuby"&gt;eRuby&lt;/a&gt; pour la rédaction des
  articles.
&lt;/p&gt;

&lt;p&gt;
  Le principal problème de Markdown est que le format est limité et il faut
  souvent utiliser des dialectes (comme le &lt;em&gt;GitHub Flavored Markdown&lt;/em&gt;)
  pour avoir plus de fonctionnalités. Par exemple, Octopress utilise
  &lt;a href="https://kramdown.gettalong.org/"&gt;kramdown&lt;/a&gt; (qui est déjà un
  Markdown enrichi) couplé avec
  &lt;a href="https://shopify.github.io/liquid/"&gt;Liquid&lt;/a&gt;.
&lt;/p&gt;

&lt;p&gt;
  En utilisant eRuby, j’ai toutes les fonctionnalités nécessaires avec un seul
  langage, sans avoir à recourir à des extensions ou dialectes. Et en bonus
  j’ai un contrôle beaucoup plus fin sur le HTML généré (au contraire de
  Markdown), ce qui est très pratique.
&lt;/p&gt;

&lt;h3&gt;La coloration syntaxique&lt;/h3&gt;

&lt;p&gt;
  Pour la coloration syntaxique des blocs de code, il n’y a rien de prévu par
  défaut dans Nanoc (au contraire d’Octopress). Je suis donc allé faire un tour
  sur le blog de kAworu pour voir ce qu’il utilisait :
  &lt;a href="http://rouge.jneen.net/"&gt;Rouge&lt;/a&gt; via
  &lt;a href="https://github.com/kAworu/kaworu.ch/blob/4f64985deb187ef7abb0494c602a3c69806f1b8a/lib/filters/octohilight.rb"&gt;un filtre Nanoc fait maison&lt;/a&gt;.
&lt;/p&gt;

&lt;p&gt;
  Je me suis donc très fortement inspiré de son approche, avec toutefois
  quelques petites simplifications (étant donné que je n’avais pas besoin de
  certaines fonctionnalités).
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;highlight.rb&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'json'&lt;/span&gt;

&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'rouge'&lt;/span&gt;

&lt;span class="no"&gt;Nanoc&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Filter&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:highlight&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_params&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;gsub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sr"&gt;/```(?&amp;lt;options&amp;gt;\{[^}]*\})?\n(?&amp;lt;code&amp;gt;.+?)```$/m&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
    &lt;span class="c1"&gt;# Get options.&lt;/span&gt;
    &lt;span class="n"&gt;options&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;JSON&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;Regexp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;last_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:options&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="s1"&gt;'{}'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;lang&lt;/span&gt;    &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'lang'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'text'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;title&lt;/span&gt;   &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'title'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;''&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;linenos&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'linenos'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kp"&gt;true&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# Highlight code.&lt;/span&gt;
    &lt;span class="n"&gt;formatter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Rouge&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Formatters&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;HTML&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;
    &lt;span class="n"&gt;formatter&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Rouge&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Formatters&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;HTMLTable&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;formatter&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;linenos&lt;/span&gt;
    &lt;span class="n"&gt;lexer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Rouge&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Lexer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;find&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lang&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;code&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;formatter&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lexer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;lex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;Regexp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;last_match&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:code&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;
    &lt;span class="c1"&gt;# Wrap the result.&lt;/span&gt;
    &lt;span class="n"&gt;title&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;figcaption&amp;gt;&lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;lt;/figcaption&amp;gt;"&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;empty?&lt;/span&gt;
    &lt;span class="n"&gt;code&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;pre&amp;gt;&lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;lt;/pre&amp;gt;"&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="n"&gt;linenos&lt;/span&gt;
    &lt;span class="o"&gt;&amp;lt;&amp;lt;-&lt;/span&gt;&lt;span class="no"&gt;HTML&lt;/span&gt;&lt;span class="sh"&gt;
    &amp;lt;figure class="code"&amp;gt;
      &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;title&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sh"&gt;
      &amp;lt;div class="highlight"&amp;gt;
        &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sh"&gt;
      &amp;lt;/div&amp;gt;
    &amp;lt;/figure&amp;gt;
&lt;/span&gt;&lt;span class="no"&gt;    HTML&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;h3&gt;La gestion des catégories&lt;/h3&gt;

&lt;p&gt;
  Nanoc fourni déjà
  &lt;a href="https://nanoc.app/doc/reference/helpers/#tagging"&gt;quelques fonctions&lt;/a&gt;
  pour gérer les catégories sur les articles. Malheureusement ces fonctions ne
  gèrent pas très bien les catégories qui contiennent des espaces (« Trucs et
  astuces » par exemple), et cela pose problème si l’on souhaite utiliser une
  catégorie en tant qu’ancre ou ID HTML.
&lt;/p&gt;

&lt;p&gt;J’ai donc réimplémenté moi-même certaines de ces fonctions :&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="c1"&gt;# Return the articles tagged with `tag`, sorted by descending creation date.&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;articles_with_tag&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="n"&gt;sorted_articles&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;select&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;article&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;article&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:tags&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[]).&lt;/span&gt;&lt;span class="nf"&gt;include?&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;

&lt;span class="c1"&gt;# Return a formatted list of tags for the given item as a string.&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;tags_for&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;separator: &lt;/span&gt;&lt;span class="s1"&gt;', '&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="n"&gt;base_url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'/blog/tags/#'&lt;/span&gt;
  &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="ss"&gt;:tags&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;map&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="sx"&gt;%(&amp;lt;a href="#{base_url}#{to_html_id(tag)}" rel="tag"&amp;gt;#{tag}&amp;lt;/a&amp;gt;)&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;separator&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;

&lt;span class="c1"&gt;# Return a version of `str` that can be used as an HTML ID.&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;to_html_id&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;downcase&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;tr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;' '&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'-'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Au passage, j’ai également dû coder une fonction qui me renvoie la liste des
  catégories triée par ordre alphabétique. Le fait que j’utilise le français
  implique que je ne peux pas utiliser la fonction &lt;code&gt;sort&lt;/code&gt; de Ruby car
  elle ne gère pas correctement l’ordre des caractères non ASCII.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;['Développement', 'Divers', 'Design Patterns'].sort
=&amp;gt; ["Design Patterns", "Divers", "Développement"]
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  On voit que &lt;code&gt;Dé&lt;/code&gt; est placé après &lt;code&gt;Di&lt;/code&gt;, ce qui est
  incorrect : il devrait être placé avant &lt;code&gt;Di&lt;/code&gt; (mais bien
  après &lt;code&gt;De&lt;/code&gt;). Pour pallier au problème, j’ai utilisé la gem
  &lt;a href="https://github.com/grosser/sort_alphabetical"&gt;sort_alphabetical&lt;/a&gt; :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;pre&gt;['Développement', 'Divers', 'Design Patterns'].sort_alphabetical
=&amp;gt; ["Design Patterns", "Développement", "Divers"]
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Cette fois, l’ordre est correct. Il suffit ensuite d’utiliser cette fonction
  sur la liste des catégories :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'sort_alphabetical'&lt;/span&gt;

&lt;span class="c1"&gt;# Return a list of existing tags, sorted alphabetically.&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;tags&lt;/span&gt;
  &lt;span class="vi"&gt;@items&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;inject&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;Set&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;merge&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:tags&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[]))&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;to_a&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;sort_alphabetical&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;h3&gt;Les vérifications automatisées&lt;/h3&gt;

&lt;p&gt;
  Nanoc propose
  &lt;a href="https://nanoc.app/doc/testing/"&gt;un système de validation&lt;/a&gt; qui
  permet d’exécuter (manuellement ou avant de déployer le site) des étapes de
  vérifications sur le contenu du site généré. C’est extrêmement pratique pour
  détecter des erreurs (telles que des liens cassés) lors du développement/avant
  de déployer le site.
&lt;/p&gt;

&lt;p&gt;
  J’ai donc mit à jour mon &lt;code&gt;nanoc.yaml&lt;/code&gt; pour activer les
  vérifications suivantes :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;css_local&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;html_local&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;atom&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;sitemap&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;external_links&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;internal_links&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;stale&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  &lt;code&gt;external_links&lt;/code&gt;, &lt;code&gt;internal_links&lt;/code&gt; et &lt;code&gt;stale&lt;/code&gt;
  sont fournis par Nanoc. Les deux premiers vérifient que les liens utilisés
  sont valides et le dernier vérifie qu’il n’y a pas de fichiers inattendu dans
  le répertoire qui est copié lors du déploiement.
&lt;/p&gt;

&lt;h4&gt;HTML et CSS&lt;/h4&gt;

&lt;p&gt;
  &lt;code&gt;css_local&lt;/code&gt; et &lt;code&gt;html_local&lt;/code&gt; vérifient que le CSS et le
  HTML sont bien valides. Nanoc propose déjà ce genre de vérification
  via &lt;code&gt;css&lt;/code&gt; et &lt;code&gt;html&lt;/code&gt;, mais ils ne me convenaient pas pour
  les raisons suivantes :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    ils ne remontent que les erreurs, or les avertissements sont parfois
    intéressants à prendre en compte (même si pas obligatoire).
  &lt;/li&gt;
  &lt;li&gt;
    ils fonctionnent en faisant des requêtes sur
    &lt;a href="https://validator.w3.org/"&gt;les validateurs du W3C&lt;/a&gt;, ce qui
    requiert d’avoir un accès à Internet.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  C’est pourquoi j’ai implémenté &lt;code&gt;css_local&lt;/code&gt;
  et &lt;code&gt;html_local&lt;/code&gt; qui utilisent un
  &lt;a href="https://github.com/validator/validator"&gt;validatornu&lt;/a&gt;
  installé localement.
  &lt;br /&gt;
  Un autre avantage à cela, en plus de fonctionner hors-ligne, est que je peux
  maintenant avoir accès aux avertissements (et ignorer ceux qui me semblent non
  pertinents).
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;css_local&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="no"&gt;Nanoc&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Check&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:css_local&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'json'&lt;/span&gt;
  &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'open3'&lt;/span&gt;

  &lt;span class="vi"&gt;@output_filenames&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="k"&gt;next&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;extname&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;'.css'&lt;/span&gt;

    &lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="sx"&gt;%W[validatornu --css --format json &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sx"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Open3&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;capture2e&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;next&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;empty?&lt;/span&gt;

    &lt;span class="no"&gt;JSON&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="s1"&gt;'messages'&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
      &lt;span class="n"&gt;reason&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'message'&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;delete_prefix&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'CSS: '&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;errmsg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"l.&lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'lastLine'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt; - &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;reason&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
      &lt;span class="n"&gt;add_issue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;errmsg&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;subject: &lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


    &lt;figure class="code"&gt;
      &lt;figcaption&gt;html_local&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="no"&gt;Nanoc&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Check&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:html_local&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'json'&lt;/span&gt;
  &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'open3'&lt;/span&gt;

  &lt;span class="no"&gt;IGNORE_LIST&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
    &lt;span class="c1"&gt;# Nope, that's not the HTML5 way.&lt;/span&gt;
    &lt;span class="s1"&gt;'Consider using the “h1” element as a top-level heading only'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="c1"&gt;# My &amp;lt;article&amp;gt; use h1, they have header…&lt;/span&gt;
    &lt;span class="s1"&gt;'Article lacks heading. Consider using “h2”-“h6”'&lt;/span&gt;
  &lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;freeze&lt;/span&gt;

  &lt;span class="vi"&gt;@output_filenames&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="k"&gt;next&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;extname&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;'.html'&lt;/span&gt;

    &lt;span class="n"&gt;command&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="sx"&gt;%W[validatornu --html --format json &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sx"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Open3&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;capture2e&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;command&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;next&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;empty?&lt;/span&gt;

    &lt;span class="no"&gt;JSON&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;parse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;output&lt;/span&gt;&lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="s1"&gt;'messages'&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
      &lt;span class="n"&gt;errmsg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'message'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
      &lt;span class="k"&gt;next&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="no"&gt;IGNORE_LIST&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;any?&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;errmsg&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;include?&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;

      &lt;span class="n"&gt;add_issue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"l.&lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'lastLine'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt; - &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;errmsg&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;subject: &lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;h4&gt;Sitemap&lt;/h4&gt;

&lt;p&gt;
  &lt;code&gt;sitemap&lt;/code&gt; vérifie, à l’aide de l’excellente bibiothèque
  &lt;a href="https://nokogiri.org/"&gt;Nokogiri&lt;/a&gt;, que le &lt;code&gt;sitemap.xml&lt;/code&gt;
  généré est un XML valide &lt;strong&gt;ET&lt;/strong&gt; qu’il respecte bien le schéma
  attendu (j’ai récupéré le &lt;code&gt;sitemap.xsd&lt;/code&gt; dans
  &lt;a href="https://github.com/kAworu/kaworu.ch/"&gt;les sources du blog de kAworu&lt;/a&gt;).
&lt;/p&gt;


    &lt;figure class="code"&gt;
      &lt;figcaption&gt;sitemap&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="no"&gt;Nanoc&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Check&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:sitemap&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'nokogiri'&lt;/span&gt;

  &lt;span class="vi"&gt;@output_filenames&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="k"&gt;next&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;basename&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;'sitemap.xml'&lt;/span&gt;

    &lt;span class="n"&gt;xsd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Nokogiri&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;XML&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Schema&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'misc/sitemap.xsd'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;sitemap&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Nokogiri&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;XML&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;xsd&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;validate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sitemap&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
      &lt;span class="n"&gt;add_issue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;subject: &lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;h4&gt;Atom&lt;/h4&gt;

&lt;p&gt;
  Pour &lt;code&gt;atom&lt;/code&gt; c’est le même principe que &lt;code&gt;sitemap&lt;/code&gt; : on
  utilise Nokogiri pour valider le XML de &lt;code&gt;atom.xml&lt;/code&gt;, ainsi que la
  validité du schéma.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;atom&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="no"&gt;Nanoc&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Check&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:atom&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'nokogiri'&lt;/span&gt;

  &lt;span class="vi"&gt;@output_filenames&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="k"&gt;next&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;basename&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;'atom.xml'&lt;/span&gt;

    &lt;span class="n"&gt;rng&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Nokogiri&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;XML&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;RelaxNG&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'misc/atom.rng'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;sitemap&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Nokogiri&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;XML&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;rng&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;validate&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sitemap&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
      &lt;span class="n"&gt;add_issue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;subject: &lt;/span&gt;&lt;span class="n"&gt;filename&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  On remarquera que cette fois le schéma n’est pas défini par un
  fichier &lt;code&gt;.xsd&lt;/code&gt;. En effet, il n’y a pas de &lt;em&gt;XSD&lt;/em&gt;
  (&lt;em&gt;XML Schema Definition&lt;/em&gt;) officielle pour le format Atom. La
  &lt;a href="https://validator.w3.org/feed/docs/rfc4287.html#rfc.section.B"&gt;RFC 4287&lt;/a&gt;
  fourni une spécification &lt;em&gt;Relax NG&lt;/em&gt; (&lt;em&gt;&lt;strong&gt;Re&lt;/strong&gt;gular
  &lt;strong&gt;La&lt;/strong&gt;nguage for &lt;strong&gt;X&lt;/strong&gt;ML &lt;strong&gt;N&lt;/strong&gt;ext
  &lt;strong&gt;G&lt;/strong&gt;eneration&lt;/em&gt;). Cependant il y a un problème : la
  RFC utilise la
  &lt;a href="https://relaxng.org/compact-20021121.html"&gt;syntaxe compacte&lt;/a&gt;, et
  cette syntaxe ne peut pas être utilisée par Nokogiri. Heureusement, il est
  possible de la convertir en syntaxe standard (utilisable par Nokogiri)
  avec &lt;a href="https://relaxng.org/jclark/trang.html"&gt;trang&lt;/a&gt;.
&lt;/p&gt;

&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;
  La migration fut relativement simple, je n’ai pas eu trop de glue à faire
  moi-même. Seule la conversion des articles en Markdown vers eRuby a été un peu
  laborieuse, mais ça m’a permis de fixer deux ou trois trucs au passage, donc
  plutôt positif au final.
&lt;/p&gt;
</content>
  </entry>
  <entry>
    <id>tag:grim7reaper.github.io,2017-09-06:/blog/2017/09/06/compilation-a-la-volee-avec-ruby/</id>
    <title type="html">Compilation à la volée avec Ruby</title>
    <published>2017-09-06T00:00:00Z</published>
    <updated>2017-09-06T00:00:00Z</updated>
    <link rel="alternate" href="https://grim7reaper.github.io/blog/2017/09/06/compilation-a-la-volee-avec-ruby/" type="text/html"/>
    <content type="html">&lt;p&gt;
  Récemment, je suis tombé sur cette série d’articles d’Eli Bendersky sur la
  compilation à la volée (&lt;strong&gt;JIT compilation&lt;/strong&gt; : &lt;em&gt;Just-In-Time
  compilation&lt;/em&gt;) :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;a href="https://eli.thegreenplace.net/2017/adventures-in-jit-compilation-part-1-an-interpreter/"&gt;Adventures in JIT compilation: Part 1 - an interpreter&lt;/a&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;a href="https://eli.thegreenplace.net/2017/adventures-in-jit-compilation-part-2-an-x64-jit/"&gt;Adventures in JIT compilation: Part 2 - an x64 JIT&lt;/a&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;a href="https://eli.thegreenplace.net/2017/adventures-in-jit-compilation-part-3-llvm/"&gt;Adventures in JIT compilation: Part 3 - LLVM&lt;/a&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;a href="https://eli.thegreenplace.net/2017/adventures-in-jit-compilation-part-4-in-python/"&gt;Adventures in JIT compilation: Part 4 - in Python&lt;/a&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Eli utilise le C++ pour les trois premières parties, mais dans la quatrième il
  montre comment faire de la compilation à la volée en Python.
&lt;/p&gt;

&lt;p&gt;
  En lisant ça, je me suis demandé « Comment faire l’équivalent en Ruby ? ». Et
  bien c’est ce que nous allons voir !
&lt;/p&gt;

&lt;p&gt;
  &lt;em&gt;
    Pour des raisons de simplicité et concision, les exemples de codes de cet
    article ne sont pas portable (limité à Linux/x86_64). Cependant, la démarche
    présentée est applicable sur d’autres OS/architecture.
  &lt;/em&gt;
&lt;/p&gt;

&lt;h2&gt;Comment exécuter du code compilé à la volée en Ruby&lt;/h2&gt;

&lt;p&gt;Les étapes pour exécuter du code compilé à la volée sont les suivantes :&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    Allouer de la mémoire pour y placer le code à exécuter.
  &lt;/li&gt;
  &lt;li&gt;
    Créer une fonction à partir de l’adresse de la zone mémoire contenant le
    code.
  &lt;/li&gt;
  &lt;li&gt;
    Utiliser la fonction autant que l’on veut.
  &lt;/li&gt;
  &lt;li&gt;
    Libérer la mémoire utilisée.
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;
  Étant donné que nous allons devoir faire de la programmation relativement bas
  niveau (allocation mémoire entre autre), nous allons nous reposer sur
  l’excellent module &lt;a href="https://github.com/ffi/ffi"&gt;ffi&lt;/a&gt; (dont j’ai
  déjà eu l’occasion de parler
  &lt;a href="/blog/2013/09/14/ffi-avec-ruby/"&gt;ici&lt;/a&gt;).
&lt;/p&gt;

&lt;p&gt;
  En première approche pour l’étape 1 on pourrait penser à
  &lt;code&gt;FFI::MemoryPointer.new&lt;/code&gt; mais il y a de &lt;strong&gt;très&lt;/strong&gt;
  fortes chances pour que cela se termine en &lt;em&gt;Segmentation Fault&lt;/em&gt; (ou
  équivalent).
&lt;/p&gt;

&lt;p&gt;
  En effet, pour des raisons de sécurité, la mémoire est généralement allouée
  soit en « lecture/écriture » (&lt;strong&gt;RW&lt;/strong&gt; : &lt;em&gt;read/write&lt;/em&gt;), soit
  en « lecture/exécution » (&lt;strong&gt;RX&lt;/strong&gt; :
  &lt;em&gt;read/execute&lt;/em&gt;)&lt;sup id="fnref:1"&gt;&lt;a href="#fn:1"&gt;1&lt;/a&gt;&lt;/sup&gt;.
  Et comme, de manière générale, les fonctions d’allocation (&lt;code&gt;malloc&lt;/code&gt;
  &amp; &lt;em&gt;cie&lt;/em&gt; en C, &lt;code&gt;FFI::MemoryPointer.new&lt;/code&gt; en Ruby, …) renvoient
  de la mémoire &lt;strong&gt;RW&lt;/strong&gt; nous ne pourrons pas les utiliser pour
  allouer la mémoire où nous allons placer notre code.
&lt;/p&gt;

&lt;p&gt;
  Heureusement, il existe un appel système qui nous permet de spécifier les
  droits d’une zone mémoire lors de son allocation : &lt;code&gt;mmap&lt;/code&gt;. Cette
  fonction est extrêmement pratique et a de nombreux cas d’usages, mais dans le
  cas présent nous allons en avoir une utilisation assez simple :
&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    Allouer via &lt;code&gt;mmap&lt;/code&gt; une zone mémoire de taille suffisante pour
    recevoir le code (cette zone sera allouée en &lt;strong&gt;RW&lt;/strong&gt;).
  &lt;/li&gt;
  &lt;li&gt;
    Stocker le code dans cette zone mémoire.
  &lt;/li&gt;
  &lt;li&gt;
    Changer les permissions de la zone mémoire via &lt;code&gt;mprotect&lt;/code&gt; pour la
    passer en &lt;strong&gt;RX&lt;/strong&gt;.
  &lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;
  Nous pourrions directement allouer la mémoire en &lt;strong&gt;RWX&lt;/strong&gt; (et
  ainsi éviter d’avoir à appeler &lt;code&gt;mprotect&lt;/code&gt;) mais ce n’est pas une
  bonne pratique (du point de vue sécurité) d’avoir les droits en
  écriture &lt;strong&gt;ET&lt;/strong&gt; en exécution en même temps sur une même zone
  mémoire.
&lt;/p&gt;

&lt;h3&gt;Wrapper mmap pour Ruby&lt;/h3&gt;

&lt;p&gt;
  Étant donné que &lt;code&gt;mmap&lt;/code&gt; &amp; &lt;em&gt;cie&lt;/em&gt; ne sont pas disponibles de
  base en Ruby, contrairement
  à &lt;a href="https://docs.python.org/3.6/library/mmap.html"&gt;Python&lt;/a&gt;, nous
  allons faire un petit wrapper
  nous-même&lt;sup id="fnref:2"&gt;&lt;a href="#fn:2"&gt;2&lt;/a&gt;&lt;/sup&gt;. Ce wrapper ne sera pas
  exposé publiquement, c’est un détail d’implémentation, et sera manipulé via
  une classe qui représente une fonction compilée à la
  volée : &lt;code&gt;JitFunction&lt;/code&gt;.
&lt;/p&gt;

&lt;p&gt;Mais d’abord, voyons le wrapper en question.&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Wrapper minimaliste autour de mmap &amp; cie&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'ffi'&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;JitFunction&lt;/span&gt;

  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;…&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

  &lt;span class="k"&gt;module&lt;/span&gt; &lt;span class="nn"&gt;Internal&lt;/span&gt;
    &lt;span class="kp"&gt;extend&lt;/span&gt; &lt;span class="no"&gt;FFI&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Library&lt;/span&gt;
    &lt;span class="n"&gt;ffi_lib&lt;/span&gt; &lt;span class="no"&gt;FFI&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Library&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;LIBC&lt;/span&gt;

    &lt;span class="n"&gt;attach_function&lt;/span&gt; &lt;span class="s1"&gt;'mmap'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;     &lt;span class="sx"&gt;%i[pointer size_t int int int off_t]&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;:pointer&lt;/span&gt;
    &lt;span class="n"&gt;attach_function&lt;/span&gt; &lt;span class="s1"&gt;'mprotect'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sx"&gt;%i[pointer size_t int]&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;:int&lt;/span&gt;
    &lt;span class="n"&gt;attach_function&lt;/span&gt; &lt;span class="s1"&gt;'munmap'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;   &lt;span class="sx"&gt;%i[pointer size_t]&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;:int&lt;/span&gt;

    &lt;span class="no"&gt;PROT_NONE&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x0&lt;/span&gt; &lt;span class="c1"&gt;# Data cannot be accessed.&lt;/span&gt;
    &lt;span class="no"&gt;PROT_READ&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x1&lt;/span&gt; &lt;span class="c1"&gt;# Data can be read.&lt;/span&gt;
    &lt;span class="no"&gt;PROT_WRITE&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x2&lt;/span&gt; &lt;span class="c1"&gt;# Data can be written.&lt;/span&gt;
    &lt;span class="no"&gt;PROT_EXEC&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x4&lt;/span&gt; &lt;span class="c1"&gt;# Data can be executed.&lt;/span&gt;

    &lt;span class="no"&gt;PROT_RW&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;PROT_READ&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="no"&gt;PROT_WRITE&lt;/span&gt;
    &lt;span class="no"&gt;PROT_RX&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;PROT_READ&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="no"&gt;PROT_EXEC&lt;/span&gt;

    &lt;span class="no"&gt;MAP_SHARED&lt;/span&gt;    &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x1&lt;/span&gt;   &lt;span class="c1"&gt;# Share changes.&lt;/span&gt;
    &lt;span class="no"&gt;MAP_PRIVATE&lt;/span&gt;   &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x2&lt;/span&gt;   &lt;span class="c1"&gt;# Changes are private.&lt;/span&gt;
    &lt;span class="no"&gt;MAP_ANONYMOUS&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x20&lt;/span&gt;  &lt;span class="c1"&gt;# Don't use a file.&lt;/span&gt;

    &lt;span class="no"&gt;MAP_FAILED&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;FFI&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Pointer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:void&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="n"&gt;private_constant&lt;/span&gt; &lt;span class="ss"&gt;:Internal&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Rien de bien compliqué : on déclare les trois fonctions que nous allons
  utiliser (&lt;code&gt;mmap&lt;/code&gt; pour allouer la mémoire, &lt;code&gt;mprotect&lt;/code&gt;
  pour changer les permissions et &lt;code&gt;munmap&lt;/code&gt; pour libérer la mémoire)
  et les constantes dont nous allons avoir besoin (il existe d’autres
  constantes, vous pouvez consulter &lt;code&gt;man 2 mmap&lt;/code&gt; pour la liste
  complète).
&lt;/p&gt;

&lt;p&gt;
  &lt;strong&gt;Attention&lt;/strong&gt; : ce wrapper n’est pas portable (il ne fonctionnera
  pas pour Windows, sur d’autres UNIX les valeurs des constantes peuvent être
  différentes, …).
&lt;/p&gt;

&lt;h3&gt;La classe JitFunction&lt;/h3&gt;

&lt;p&gt;
  Voyons maintenant la classe qui va nous permettre de créer et d’exécuter des
  fonctions compilées à la volée.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Implémentation de la classe JitFunction&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'ffi'&lt;/span&gt;

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;JitFunction&lt;/span&gt;
  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;initialize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="vi"&gt;@size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;bytesize&lt;/span&gt;
    &lt;span class="vi"&gt;@address&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;mmap&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kp"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="vi"&gt;@size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;PROT_RW&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                             &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;MAP_PRIVATE&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;MAP_ANONYMOUS&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                             &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s1"&gt;'cannot map memory'&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="vi"&gt;@address&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;MAP_FAILED&lt;/span&gt;
    &lt;span class="vi"&gt;@address&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;put_string&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;status&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;mprotect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="vi"&gt;@address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="vi"&gt;@size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;PROT_RX&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s2"&gt;"cannot change memory's permission"&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;status&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;
    &lt;span class="vi"&gt;@func&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;FFI&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Function&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="vi"&gt;@address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;convention: :default&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;

  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="vi"&gt;@func&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;

  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;free&lt;/span&gt;
    &lt;span class="no"&gt;Internal&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;munmap&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="vi"&gt;@address&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="vi"&gt;@size&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;

  &lt;span class="k"&gt;module&lt;/span&gt; &lt;span class="nn"&gt;Internal&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;…&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="n"&gt;private_constant&lt;/span&gt; &lt;span class="ss"&gt;:Internal&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  On peut voir que l’interface de la classe est composée de trois méthodes
  publiques :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;code&gt;initialize&lt;/code&gt; qui prend en argument le code de la fonction et qui
    crée un objet &lt;code&gt;FFI::Function&lt;/code&gt;.
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;call&lt;/code&gt; qui permet d’exécuter la fonction.
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;free&lt;/code&gt; qui libère la mémoire utilisée par le code de la fonction.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Il n’y a pas grand chose à dire sur &lt;code&gt;call&lt;/code&gt; (un simple wrapper
  autour de la méthode &lt;code&gt;call&lt;/code&gt; de l’objet &lt;code&gt;FFI::Function&lt;/code&gt;)
  ou &lt;code&gt;free&lt;/code&gt; (un simple wrapper autour de &lt;code&gt;munmap&lt;/code&gt;).
&lt;/p&gt;

&lt;p&gt;En revanche, &lt;code&gt;initialize&lt;/code&gt; mérite que l’on s’y attarde.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    La ligne 5 récupère la taille, en octet, du code de la fonction.
  &lt;/li&gt;
  &lt;li&gt;
    La ligne 6 alloue la mémoire pour le code via &lt;code&gt;mmap&lt;/code&gt;. On remarque
    que la mémoire est alloué en &lt;strong&gt;RW&lt;/strong&gt; (comme l’indique le
    paramètre &lt;code&gt;PROT_RW&lt;/code&gt;). La mémoire allouée n’est pas accessible aux
    autres processus (utilisation de &lt;code&gt;MAP_PRIVATE&lt;/code&gt; au lieu
    de &lt;code&gt;MAP_SHARED&lt;/code&gt;) et n’est pas liée à un fichier sur le disque
    (utilisation de &lt;code&gt;MAP_ANONYMOUS&lt;/code&gt;).
  &lt;/li&gt;
  &lt;li&gt;
    La ligne 9 lève une exception si l’allocation a échouée
    (&lt;strong&gt;Attention&lt;/strong&gt; : en cas d’erreur &lt;code&gt;mmap&lt;/code&gt; ne renvoie
    pas &lt;code&gt;NULL&lt;/code&gt; mais une valeur bien spécifique représentée
    par
    &lt;code&gt;MAP_FAILED&lt;/code&gt;&lt;sup id="fnref:3"&gt;&lt;a href="#fn:3"&gt;3&lt;/a&gt;&lt;/sup&gt;).
  &lt;/li&gt;
  &lt;li&gt;
    La ligne 10 copie le code de la fonction dans la zone allouée.
  &lt;/li&gt;
  &lt;li&gt;
    Étant donné que nous n’allons plus modifier la mémoire, la ligne 11 change
    les permissions de la zone mémoire de &lt;strong&gt;RW&lt;/strong&gt;
    en &lt;strong&gt;RX&lt;/strong&gt; et la ligne 12 lève une exception en cas d’échec.
  &lt;/li&gt;
  &lt;li&gt;
    Finalement, la ligne 13 crée un objet &lt;code&gt;FFI::Function&lt;/code&gt; en
    précisant le type de retour, le type des arguments et l’adresse du code à
    exécuter.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;Test&lt;/h3&gt;

&lt;p&gt;
  Nous pouvons maintenant tester la classe &lt;code&gt;JitFunction&lt;/code&gt; en reprenant
  l’exemple utilisé par Eli dans son
  &lt;a href="https://eli.thegreenplace.net/2017/adventures-in-jit-compilation-part-4-in-python/"&gt;quatrième article&lt;/a&gt; :
  une fonction qui ajoute 4 à un entier passé en argument et retourne le résultat.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Exemple d’utilisation de JitFunction&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="kp"&gt;__FILE__&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="vg"&gt;$PROGRAM_NAME&lt;/span&gt;
  &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x48\x89\xf8\x48\x83\xc0\x04\xc3&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
  &lt;span class="n"&gt;func&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;JitFunction&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:long&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="ss"&gt;:long&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;begin&lt;/span&gt;
    &lt;span class="nb"&gt;puts&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;ensure&lt;/span&gt;
    &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;free&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Lorsque l’on exécute ce script, &lt;code&gt;-96&lt;/code&gt; s’affiche. Ça fonctionne \o/
&lt;/p&gt;

&lt;p&gt;
  Le code complet de &lt;code&gt;jit.rb&lt;/code&gt; est disponible
  &lt;a href="/static/code/ruby-jit/jit.rb"&gt;ici&lt;/a&gt;.
&lt;/p&gt;

&lt;h2&gt;Exemple d’utilisation : Brainfuck&lt;/h2&gt;

&lt;p&gt;
  Afin de montrer un exemple d’utilisation « réel » de la
  classe &lt;code&gt;JitFunction&lt;/code&gt;, nous allons développer un programme qui va
  compiler à la volée un programme Brainfuck en assembleur x86_64 pour Linux
  puis l’exécuter : &lt;code&gt;bf-jit.rb&lt;/code&gt;.
&lt;/p&gt;

&lt;h3&gt;Point d’entrée&lt;/h3&gt;

&lt;p&gt;Commençons par le commencement : la fonction &lt;code&gt;main&lt;/code&gt;.&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Point d’entrée&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'set'&lt;/span&gt;

&lt;span class="c1"&gt;# Brainfuck's instruction set.&lt;/span&gt;
&lt;span class="no"&gt;INSTRUCTION_SET&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Set&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'[]&amp;gt;&amp;lt;+-.,'&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;chars&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nf"&gt;freeze&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="kp"&gt;__FILE__&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="vg"&gt;$PROGRAM_NAME&lt;/span&gt;
  &lt;span class="nb"&gt;abort&lt;/span&gt; &lt;span class="s1"&gt;'Missing argument: expected filename'&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="no"&gt;ARGV&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;empty?&lt;/span&gt;
  &lt;span class="n"&gt;bf_code&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;read&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;ARGV&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]).&lt;/span&gt;&lt;span class="nf"&gt;chars&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;select!&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="no"&gt;INSTRUCTION_SET&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;include?&lt;/span&gt; &lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
  &lt;span class="n"&gt;memory&lt;/span&gt;  &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;FFI&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;MemoryPointer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:uchar&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;30_000&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="n"&gt;bf_prog&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;JitFunction&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:void&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[],&lt;/span&gt; &lt;span class="n"&gt;compile_bf&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bf_code&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
  &lt;span class="k"&gt;begin&lt;/span&gt;
    &lt;span class="n"&gt;bf_prog&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;call&lt;/span&gt;
  &lt;span class="k"&gt;ensure&lt;/span&gt;
    &lt;span class="n"&gt;bf_prog&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;free&lt;/span&gt;
    &lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;free&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;ul&gt;
  &lt;li&gt;
    La ligne 7 vérifie que le script est bien appelé avec un argument (le nom du
    fichier source Brainfuck).
  &lt;/li&gt;
  &lt;li&gt;
    La ligne 8 lit le contenu du fichier et ne garde que les caractères qui font
    partie du jeu d’instructions Brainfuck.
  &lt;/li&gt;
  &lt;li&gt;
    La ligne 9 alloue la mémoire pour l’exécution du programme (pour rappel, un
    programme Brainfuck s’attend à avoir au moins 30 000 octets de mémoire à
    disposition).
  &lt;/li&gt;
  &lt;li&gt;
    La ligne 10 compile le code source et crée un
    objet &lt;code&gt;JitFunction&lt;/code&gt;. Étant donné que le programme Brainfuck
    s’exécute sans interaction avec le reste du script on le représente par une
    fonction sans argument et avec un type de retour &lt;code&gt;void&lt;/code&gt;.
  &lt;/li&gt;
  &lt;li&gt;
    Finalement, la ligne 12 exécute la fonction et les lignes 14 et 15 libèrent
    la mémoire allouée.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;La compilation&lt;/h3&gt;

&lt;p&gt;Pour rappel, les instructions du Brainfuck sont les suivantes :&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;code&gt;&lt;/code&gt; : déplace le pointeur d’une case mémoire vers la
    droite ;&lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;&amp;lt;&lt;/code&gt; : déplace le pointeur d’une case mémoire vers la
    gauche ;&lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;+&lt;/code&gt; : incrémente la valeur stockée dans la case mémoire
    actuellement pointée ;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;-&lt;/code&gt; : décrémente la valeur stockée dans la case mémoire
    actuellement pointée ;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;.&lt;/code&gt; : affiche le caractère ASCII correspondant à la valeur de la
    case mémoire actuellement pointée ;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;,&lt;/code&gt; : stocke la valeur ASCII du caractère lu dans la case mémoire
    actuellement pointée ;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;[&lt;/code&gt; : saute à l’instruction suivant le &lt;code&gt;]&lt;/code&gt;
    correspondant si la valeur de la case mémoire actuellement pointée est égale
    à zéro ;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;code&gt;]&lt;/code&gt; : saute à l’instruction suivant le &lt;code&gt;[&lt;/code&gt;
    correspondant si la valeur de la case mémoire actuellement pointée est
    différente de zéro.
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  On voit que pour interpréter du code Brainfuck nous allons avoir besoin de
  deux pointeurs :
&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    un pointeur sur la mémoire : c’est le pointeur utilisé par la plupart des
    instructions (toutes sauf &lt;code&gt;[&lt;/code&gt; et &lt;code&gt;]&lt;/code&gt;).
  &lt;/li&gt;
  &lt;li&gt;
    un pointeur sur le code : c’est le pointeur qui permet de savoir quelle est
    la prochaine instruction à exécuter (il est incrémenté automatiquement après
    chaque instruction, sauf pour les instructions &lt;code&gt;[&lt;/code&gt; et
    &lt;code&gt;]&lt;/code&gt; qui peuvent le modifier de manière conditionnelle).
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;
  Dans le cadre d’un interpréteur, nous devons gérer ces deux pointeurs
  nous-même. En revanche, dans le cas de la compilation à la volée, nous allons
  générer du code machine et c’est le processeur qui va s’occuper de savoir
  quelle est la prochaine instruction à exécuter : nous avons seulement besoin
  de gérer le pointeur sur la mémoire. Pour représenter ce pointeur nous allons
  utiliser un registre. Cependant, on ne peut pas utiliser n’importe quel
  registre : il y a des conventions d’utilisation. En regardant la
  section &lt;em&gt;Registers&lt;/em&gt; de
  &lt;a href="https://web.archive.org/web/20200807161717/https://web.stanford.edu/class/archive/cs/cs107/cs107.1202/guide/x86-64.html"&gt;Guide to x86-64&lt;/a&gt;
  on voit que &lt;code&gt;r10&lt;/code&gt; est un bon choix (sa valeur est sauvegardé par
  l’appelant, on peut donc l’utiliser comme on le souhaite).
&lt;/p&gt;

&lt;p&gt;
  Avec ces informations en tête, nous pouvons esquisser le squelette de notre
  fonction de compilation.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Prologue et épilogue&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;compile_bf&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="c1"&gt;# movabs r10, @memory (in little-endian)&lt;/span&gt;
  &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x49\xBA&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;address&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Q&amp;lt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
  &lt;span class="n"&gt;bf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;instruction&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="n"&gt;instruction&lt;/span&gt;
      &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;…&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\xC3&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="c1"&gt;# ret&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  On peut voir qu’il y a du code ajouté avant (le prologue) et après
  (l’épilogue) les instructions générées à partir du code Brainfuck (qui vont
  être produites dans le bloc &lt;code&gt;each&lt;/code&gt;).
&lt;/p&gt;

&lt;p&gt;
  Dans le prologue, nous initialisons le registre &lt;code&gt;r10&lt;/code&gt; avec
  l’adresse de la mémoire allouée pour l’exécution du programme Brainfuck. Deux
  remarques :
&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    les processeurs x86_64 étant &lt;em&gt;little-endian&lt;/em&gt;, nous utilisons le
    format &lt;code&gt;Q&amp;lt;&lt;/code&gt; pour écrire l’adresse comme un entier
    64-bit &lt;em&gt;little-endian&lt;/em&gt;.
  &lt;/li&gt;
  &lt;li&gt;
    on utilise la fonction &lt;code&gt;b&lt;/code&gt; de la classe &lt;code&gt;String&lt;/code&gt; pour
    que notre chaîne de caractères soit traitées comme une suite d’octets (ce
    qu’elle est) et non pas comme du texte encodé (en UTF-8 par exemple).
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;
  Dans l’épilogue, nous ajoutons l’instruction &lt;code&gt;ret&lt;/code&gt;. En effet, notre
  programme Brainfuck étant compilé en une fonction, il ne faut pas oublier
  l’instruction &lt;code&gt;ret&lt;/code&gt; pour revenir dans le code appelant à la fin de
  l’exécution.
&lt;/p&gt;

&lt;h4&gt;Compilation des instructions « simples »&lt;/h4&gt;

&lt;p&gt;
  Sur les huit instructions du Brainfuck, six peuvent être traduites directement
  en assembleur, indépendamment du contexte. Les deux dernières (&lt;code&gt;[&lt;/code&gt;
  et &lt;code&gt;]&lt;/code&gt;) demandent un peu plus d’effort et seront traitées dans la
  section suivante.
&lt;/p&gt;

&lt;p&gt;
  En reprenant la description des instructions de la section précédente et
  sachant que notre pointeur est stocké dans &lt;code&gt;r10&lt;/code&gt;, nous avons les
  correspondances suivantes :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;&gt;&lt;/code&gt; : &lt;code&gt;inc r10&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;&amp;lt;&lt;/code&gt; : &lt;code&gt;dec r10&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;+&lt;/code&gt; : &lt;code&gt;addb [r10], 1&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;-&lt;/code&gt; : &lt;code&gt;subb [r10], 1&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;
  Pour l’instruction &lt;code&gt;,&lt;/code&gt; nous devons utiliser l’appel
  système &lt;code&gt;read&lt;/code&gt; et pour &lt;code&gt;.&lt;/code&gt; nous devons utiliser l’appel
  système &lt;code&gt;write&lt;/code&gt;.
&lt;/p&gt;

&lt;p&gt;
  Pour faire un appel système en assembleur x86_64 sous Linux ce n’est pas très
  difficile : il suffit de mettre des valeurs dans des registres, puis d’utiliser
  l’instruction &lt;code&gt;syscall&lt;/code&gt;. Pour savoir quelle valeur mettre dans quel
  registre, on peut se référer à la page
  &lt;a href="http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/"&gt;Linux System Call Table for x86 64&lt;/a&gt;
  par exemple.
&lt;/p&gt;

&lt;p&gt;Cela nous donne donc&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Appel système à read&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;mov rax, 0      # On veut appeler read.
mov rdi, 0      # On lit sur stdin.
mov rsi, r10    # On veut l’écrire sur la case mémoire actuellement pointée.
mov rdx, 1      # On veut lire seulement 1 octet.
syscall
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;et&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Appel système à write&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;mov rax, 1      # On veut appeler write.
mov rdi, 1      # On écrit sur stdout.
mov rsi, r10    # On veut écrire la case mémoire actuellement pointée.
mov rdx, 1      # On veut écrire seulement 1 octet.
syscall
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Bon, nous avons maintenant l’équivalent en assembleur de nos instructions
  Brainfuck. Cependant, ce n’est pas suffisant car nous devons générer du code
  machine directement. Il nous faut donc savoir comment ces instructions sont
  encodées. Il y a plusieurs façons de faire cela, pour ma part j’ai utilisé
  &lt;code&gt;rasm2&lt;/code&gt; qui est un utilitaire faisant partie
  de &lt;a href="https://www.radare.org/r/"&gt;radare2&lt;/a&gt;.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Utilisation de rasm2 pour encoder les instructions&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;pre&gt;% rasm2 -b 64 -a x86.as 'inc r10'
49ffc2
% rasm2 -b 64 -a x86.as 'dec r10'
49ffca
rasm2 -b 64 -a x86.as 'subb [r10], 1'
41802a01
% rasm2 -b 64 -a x86.as 'addb [r10], 1'
41800201

% rasm2 -b 64 -a x86.as 'mov rax, 1'
48c7c001000000
% rasm2 -b 64 -a x86.as 'mov rdi, 1'
48c7c701000000
% rasm2 -b 64 -a x86.as 'mov rsi, r10'
4c89d6
% rasm2 -b 64 -a x86.as 'mov rdx, 1'
48c7c201000000
% rasm2 -b 64 -a x86.as 'syscall'
0f05

% rasm2 -b 64 -a x86.as 'mov rax, 0'
48c7c000000000
% rasm2 -b 64 -a x86.as 'mov rdi, 0'
48c7c700000000
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  L’option &lt;code&gt;-b&lt;/code&gt; indique la taille des registres et
  l’option &lt;code&gt;-a&lt;/code&gt; l’architecture (une liste complète est disponible via
  l’option &lt;code&gt;-L&lt;/code&gt;).
&lt;/p&gt;

&lt;p&gt;On peut maintenant compiler à la volée les instructions « simples ».&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Fonction de compilation à la volée (sans support des boucles)&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="c1"&gt;# Mapping f(Brainfuck instruction) = x86_64 assembly&lt;/span&gt;
&lt;span class="no"&gt;INSTRUCTIONS_MAPPING&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
  &lt;span class="s1"&gt;'&amp;gt;'&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x49\xFF\xC2&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s1"&gt;'&amp;lt;'&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x49\xFF\xCA&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s1"&gt;'+'&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x41\x80\x02\x01&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s1"&gt;'-'&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x41\x80\x2A\x01&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="s1"&gt;'.'&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x01&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x01&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x4C&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x89&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xD6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x01&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x0F&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x05&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'c*'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
  &lt;span class="s1"&gt;','&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x4C&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x89&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xD6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0xC2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x01&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x00&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="mh"&gt;0x0F&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x05&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'c*'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;}.&lt;/span&gt;&lt;span class="nf"&gt;freeze&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;compile_bf&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x49\xBA&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;address&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Q&amp;lt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
  &lt;span class="n"&gt;bf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;instruction&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="n"&gt;instruction&lt;/span&gt;
    &lt;span class="k"&gt;when&lt;/span&gt; &lt;span class="s1"&gt;'&amp;gt;'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'&amp;lt;'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'+'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'-'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'.'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;','&lt;/span&gt;
      &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="no"&gt;INSTRUCTIONS_MAPPING&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;instruction&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;when&lt;/span&gt; &lt;span class="s1"&gt;'['&lt;/span&gt;
      &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;…&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;when&lt;/span&gt; &lt;span class="s1"&gt;']'&lt;/span&gt;
      &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="err"&gt;…&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;
      &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s2"&gt;"invalid instruction: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;instruction&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\xC3&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  On remarque que j’ai ajouté une clause &lt;code&gt;else&lt;/code&gt; au &lt;code&gt;case&lt;/code&gt;.
  Cela semble inutile au premier abord, car &lt;code&gt;bf&lt;/code&gt; ne contient que des
  caractères faisant parti du jeu d’instructions du Brainfuck (grâce
  au &lt;code&gt;select&lt;/code&gt; appliqué dans la fonction &lt;code&gt;main&lt;/code&gt;).
  Cependant, ce &lt;code&gt;else&lt;/code&gt; est utile pour détecter des erreurs du
  développeur. Par exemple, dans ma première version du code le
  caractère &lt;code&gt;.&lt;/code&gt; était présent deux fois dans la
  clause &lt;code&gt;when&lt;/code&gt; de la ligne 23 et l’instruction &lt;code&gt;,&lt;/code&gt;
  n’était pas géré. Grâce au &lt;code&gt;else&lt;/code&gt;, l’erreur a été très rapidement
  mise en évidence (et corrigé !).
&lt;/p&gt;

&lt;h4&gt;Compilation des boucles&lt;/h4&gt;

&lt;p&gt;
  Il ne reste plus que deux instructions à gérer : &lt;code&gt;[&lt;/code&gt;
  et &lt;code&gt;]&lt;/code&gt;, qui permettent de faire des boucles en Brainfuck.
&lt;/p&gt;

&lt;p&gt;
  Pour rappel, l’instruction &lt;code&gt;[&lt;/code&gt; saute à l’instruction suivant
  le &lt;code&gt;]&lt;/code&gt; correspondant si la valeur de la case mémoire actuellement
  pointée est égale à zéro. En assembleur ça se traduit par :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Instructions assembleur pour [&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;cmpb [r10], 0
jz offset_vers_l_instruction_suivant_]
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Dans le cas de &lt;code&gt;]&lt;/code&gt; on fait un saut si la valeur est différente de
  zéro, ce qui donne :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Instructions assembleur pour ]&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;cmpb [r10], 0
jnz offset_vers_l_instruction_suivant_[
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Le problème étant de calculer les &lt;em&gt;offsets&lt;/em&gt; des sauts (surtout dans le
  cas de &lt;code&gt;[&lt;/code&gt; car on ne connait pas encore la position
  du &lt;code&gt;]&lt;/code&gt; correspondant au moment où l’on traite &lt;code&gt;[&lt;/code&gt;).
&lt;/p&gt;

&lt;p&gt;
  Pour résoudre ce problème, nous allons avoir besoin d’une pile et nous allons
  appliquer les opérations suivantes :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    lorsque l’on rencontre l’instruction &lt;code&gt;[&lt;/code&gt; :
    &lt;ul&gt;
      &lt;li&gt;
        on génère l’instruction de comparaison (le &lt;code&gt;cmpb&lt;/code&gt;).
      &lt;/li&gt;
      &lt;li&gt;
        on empile la position courante (&lt;code&gt;jz_pos&lt;/code&gt;) car nous devrons y
        revenir pour mettre à jour le code généré lorsque l’on trouvera
        le &lt;code&gt;]&lt;/code&gt; correspondant.
      &lt;/li&gt;
      &lt;li&gt;
        on insère un &lt;em&gt;placeholder&lt;/em&gt; de 6 octets (6 octets car
        l’instruction de saut &lt;code&gt;jz&lt;/code&gt; est encodée sur 2 octets et
        l’&lt;em&gt;offset&lt;/em&gt; est encodé sur 4 octets).
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    lorsque l’on rencontre l’instruction &lt;code&gt;]&lt;/code&gt; :
    &lt;ul&gt;
      &lt;li&gt;
        on génère l’instruction de comparaison (le &lt;code&gt;cmpb&lt;/code&gt;).
      &lt;/li&gt;
      &lt;li&gt;
        on récupère le &lt;code&gt;jz_pos&lt;/code&gt; correspondant (sur le dessus de la
        pile) : il contient l’adresse du &lt;em&gt;placeholder&lt;/em&gt; à modifier.
      &lt;/li&gt;
      &lt;li&gt;
        on calcule l’&lt;em&gt;offset&lt;/em&gt; du saut pour &lt;code&gt;[&lt;/code&gt; :
        l’&lt;em&gt;offset&lt;/em&gt; est calculé entre les deux positions situées juste
        après les instructions de saut elles-mêmes.
      &lt;/li&gt;
      &lt;li&gt;
        on remplace le &lt;em&gt;placeholder&lt;/em&gt; par un &lt;code&gt;jz&lt;/code&gt; avec
        l’&lt;em&gt;offset&lt;/em&gt; que l’on vient de calculer.
      &lt;/li&gt;
      &lt;li&gt;
        on calcule l’&lt;em&gt;offset&lt;/em&gt; dans l’autre sens pour &lt;code&gt;]&lt;/code&gt; (pour
        sauter en arrière, vers le début de la boucle) et on génère
        l’instruction &lt;code&gt;jnz&lt;/code&gt; avec cet &lt;em&gt;offset&lt;/em&gt;.
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Un petit schéma pour essayer de visualiser tout ça :&lt;/p&gt;

&lt;p&gt;
  &lt;img src="/static/images/jump_offset.png" class="centered" title="Schéma explicatif du calcul des offsets" alt="Schéma explicatif du calcul des offsets"&gt;
&lt;/p&gt;

&lt;p&gt;Et le code correspondant :&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Fonction de compilation à la volée&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;compile_bf&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;bf&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="n"&gt;stack&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
  &lt;span class="c1"&gt;# movabs r10, @memory (in little-endian)&lt;/span&gt;
  &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x49\xBA&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;memory&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;address&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Q&amp;lt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
  &lt;span class="n"&gt;bf&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;each&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;instruction&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="k"&gt;case&lt;/span&gt; &lt;span class="n"&gt;instruction&lt;/span&gt;
    &lt;span class="k"&gt;when&lt;/span&gt; &lt;span class="s1"&gt;'&amp;gt;'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'&amp;lt;'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'+'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'-'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'.'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;','&lt;/span&gt;
      &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="no"&gt;INSTRUCTIONS_MAPPING&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;instruction&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;when&lt;/span&gt; &lt;span class="s1"&gt;'['&lt;/span&gt;
      &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x41\x80\x3A\x00&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="c1"&gt;# cmpb [r10], 0&lt;/span&gt;
      &lt;span class="n"&gt;stack&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;asm&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;size&lt;/span&gt; &lt;span class="c1"&gt;# Save the offset where we will patch the jump.&lt;/span&gt;
      &lt;span class="c1"&gt;# Insert a placeholder of 6 bytes (2 for JZ + 4 for the address).&lt;/span&gt;
      &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x0F\x84\x00\x00\x00\x00&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt;
    &lt;span class="k"&gt;when&lt;/span&gt; &lt;span class="s1"&gt;']'&lt;/span&gt;
      &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s1"&gt;'unmatched ]'&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;empty?&lt;/span&gt;
      &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x41\x80\x3A\x00&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="c1"&gt;# cmpb [r10], 0&lt;/span&gt;
      &lt;span class="n"&gt;jz_pos&lt;/span&gt;     &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;pop&lt;/span&gt;    &lt;span class="c1"&gt;# Address of the JZ to patch.&lt;/span&gt;
      &lt;span class="n"&gt;start_loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;jz_pos&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;6&lt;/span&gt;   &lt;span class="c1"&gt;# Address of the first instruction of the loop body.&lt;/span&gt;
      &lt;span class="n"&gt;end_loop&lt;/span&gt;   &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asm&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;size&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;6&lt;/span&gt; &lt;span class="c1"&gt;# Address of the first instruction after the loop body.&lt;/span&gt;
      &lt;span class="c1"&gt;# Generate the jump to the start of the loop (using JNZ).&lt;/span&gt;
      &lt;span class="n"&gt;offset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;compute_jump_offset&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;end_loop&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;start_loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x0F\x85&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;offset&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'L&amp;lt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# L&amp;lt; because little endian!&lt;/span&gt;
      &lt;span class="c1"&gt;# Go back to patch the jump to the end of the loop.&lt;/span&gt;
      &lt;span class="n"&gt;offset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;compute_jump_offset&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start_loop&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;end_loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;asm&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;jz_pos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\x0F\x84&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;offset&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nf"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'L&amp;lt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;
      &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s2"&gt;"invalid instruction: &lt;/span&gt;&lt;span class="si"&gt;#{&lt;/span&gt;&lt;span class="n"&gt;instruction&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;
    &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
  &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s1"&gt;'unmatched ['&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="n"&gt;stack&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;empty?&lt;/span&gt;
  &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\xC3&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;b&lt;/span&gt; &lt;span class="c1"&gt;# ret&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  La fonction &lt;code&gt;compute_jump_offset&lt;/code&gt; est une traduction en Ruby de la
  fonction C++
  &lt;code&gt;compute_relative_32bit_offset&lt;/code&gt; d’Eli qui est disponible
  &lt;a href="https://github.com/eliben/code-for-blog/blob/master/2017/bfjit/jit_utils.cpp"&gt;ici&lt;/a&gt;.
  La seule subtilité c’est que les entiers en Ruby n’ont pas de taille fixe donc
  il faut bien penser à ne garder que les 32 premiers bits avec un masque.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;La fonction compute_jump_offset&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;compute_jump_offset&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;from&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt;
    &lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt;
    &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s1"&gt;'offset too large'&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;31&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;diff&lt;/span&gt;
  &lt;span class="k"&gt;else&lt;/span&gt;
    &lt;span class="c1"&gt;# Here the diff is negative, so we need to encode it as 2s complement.&lt;/span&gt;
    &lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt;
    &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="s1"&gt;'offset too large'&lt;/span&gt; &lt;span class="k"&gt;unless&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;31&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;diff&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt; &lt;span class="mh"&gt;0xFFFFFFFF&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Voilà ! Notre fonction de compilation est complète. Il n’y a plus qu’a
  tester :).
&lt;/p&gt;

&lt;h3&gt;Benchmark&lt;/h3&gt;

&lt;p&gt;
  Le code complet de &lt;code&gt;bf-jit.rb&lt;/code&gt; est disponible
  &lt;a href="/static/code/ruby-jit/bf-jit.rb"&gt;ici&lt;/a&gt;.
&lt;/p&gt;

&lt;p&gt;
  Pour mettre en évidence les avantages de la compilation à la volée en terme de
  performance, j’ai testé &lt;code&gt;bf-jit.rb&lt;/code&gt; contre deux autres
  implémentations parmi celles présentées dans
  &lt;a href="/blog/2010/12/30/interpreteurs-brainfuck/"&gt;mon premier article sur le Brainfuck&lt;/a&gt; :
&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;a href="/static/code/bfi/rbfi.rb"&gt;rbfi&lt;/a&gt; : un interpréteur naïf
    écrit en Ruby, par Ouranos.
  &lt;/li&gt;
  &lt;li&gt;
    &lt;a href="/static/code/bfi/cbfi.tar.xz"&gt;cbfi&lt;/a&gt; : mon interpréteur en
    C, qui implémente quelques optimisations basiques.
  &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;
  Le programme Brainfuck utilisé pour le benchmark est
  &lt;a href="/static/code/ruby-jit/primes.bf"&gt;primes.bf&lt;/a&gt; qui est un
  programme qui calcule les nombres premiers.
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Résultats&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;pre&gt;% time ./cbfi "$(cat primes.bf)" &amp;lt;&amp;lt;&amp;lt; 100
[…] 0,95s user 0,00s system 99% cpu 0,953 total

% time ./rbfi.rb primes.bf &amp;lt;&amp;lt;&amp;lt; 100
[…] 493,37s user 0,41s system 99% cpu 8:13,87 total

% time ./bf-jit.rb primes.bf &amp;lt;&amp;lt;&amp;lt; 100
[…] 0,23s user 0,02s system 99% cpu 0,249 total
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Pas mal du tout ! Presque 4x plus rapide que la version C ! Et pourtant notre
  compilateur est très stupide : il traduit le code instruction par instruction.
&lt;/p&gt;

&lt;p&gt;
  D’ailleurs, ce comportement naïf est pénalisant sur certains programmes tel
  que &lt;a href="/static/code/ruby-jit/hanoi.bf"&gt;hanoi.bf&lt;/a&gt; où mon
  interpréteur C est plus rapide (grâce à ses optimisations)
  que &lt;code&gt;bf-jit.rb&lt;/code&gt;. Cela étant dit, il nous suffirait d’implémenter
  les optimisations décrites dans les articles d’Eli pour que notre compilateur
  repasse en tête :-)
&lt;/p&gt;

&lt;h2&gt;Aller plus loin&lt;/h2&gt;

&lt;p&gt;
  Au lieu d’écrire notre code directement en hexadécimal, on peut utiliser un
  assembleur (comme &lt;a href="https://www.cr0.org/progs/metasm/"&gt;metasm&lt;/a&gt; ou
  &lt;a href="https://github.com/seattlerb/wilson"&gt;wilson&lt;/a&gt; par exemple) pour
  pouvoir utiliser des mnémoniques et améliorer la lisibilité/souplesse du code.
&lt;/p&gt;

&lt;p&gt;
  Par exemple, si l’on utilise metasm pour réécrire le petit code d’exemple de
  &lt;code&gt;jit.rb&lt;/code&gt; on obtient :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Utilisation de metasm&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;table class="rouge-table"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class="rouge-gutter gl"&gt;&lt;pre class="lineno"&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
&lt;/pre&gt;&lt;/td&gt;&lt;td class="rouge-code"&gt;&lt;pre&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="kp"&gt;__FILE__&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="vg"&gt;$PROGRAM_NAME&lt;/span&gt;
  &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s1"&gt;'metasm'&lt;/span&gt;

  &lt;span class="n"&gt;asm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;-&lt;/span&gt;&lt;span class="no"&gt;EOS&lt;/span&gt;&lt;span class="sh"&gt;
  mov rax, rdi
  add rax, 4
  ret
&lt;/span&gt;&lt;span class="no"&gt;  EOS&lt;/span&gt;
  &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;Metasm&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Shellcode&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;assemble&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;Metasm&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;X86_64&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;asm&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nf"&gt;encoded&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;data&lt;/span&gt;
  &lt;span class="n"&gt;func&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="no"&gt;JitFunction&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:long&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="ss"&gt;:long&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;code&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;begin&lt;/span&gt;
    &lt;span class="nb"&gt;puts&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;ensure&lt;/span&gt;
    &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;free&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;Ce qui est tout de même un poil plus lisible :)&lt;/p&gt;

&lt;p&gt;
  On pourrait même aller jusqu’à utiliser LLVM (via
  &lt;a href="https://github.com/ruby-llvm/ruby-llvm"&gt;ruby-llvm&lt;/a&gt;) pour générer
  du code optimisé et devenir facilement multi-plateforme au lieu d’être limité
  aux processeurs x86_64.
&lt;/p&gt;

&lt;div class="footnotes"&gt;
  &lt;hr class="weak-hr" /&gt;
  &lt;ol&gt;
    &lt;li id="fn:1"&gt;
      &lt;p&gt;
        Pour savoir pourquoi et comment, je vous renvoie sur l’article Wikipédia
        du &lt;a href="https://en.wikipedia.org/wiki/W%5EX"&gt;W^X&lt;/a&gt;.&lt;a href="#fnref:1"&gt;↩&lt;/a&gt;
    &lt;/p&gt;
    &lt;/li&gt;
    &lt;li id="fn:2"&gt;
      &lt;p&gt;
        Nous aurions pu utiliser la
        gem &lt;a href="https://rubygems.org/gems/mmap2"&gt;mmap2&lt;/a&gt;, mais vu que
        notre cas d’utilisation est relativement simple et limité c’est plus
        pédagogique de le faire soi-même.&lt;a href="#fnref:2"&gt;↩&lt;/a&gt;
    &lt;/p&gt;
    &lt;/li&gt;
    &lt;li id="fn:3"&gt;
      &lt;p&gt;
        &lt;code&gt;mmap&lt;/code&gt; ne peut pas renvoyer &lt;code&gt;NULL&lt;/code&gt; pour signaler
        une erreur car l’adresse 0 est une valeur de retour valide (en utilisant
        le flag &lt;code&gt;MAP_FIXED&lt;/code&gt;), cette fonctionnalité
        de &lt;code&gt;mmap&lt;/code&gt; a d’ailleurs souvent été utilisée pour exploiter
        des déréférencements de pointeur &lt;code&gt;NULL&lt;/code&gt; dans le noyau
        (voir &lt;a href="https://blogs.oracle.com/linux/post/much-ado-about-null-exploiting-a-kernel-null-dereference"&gt;
          cet article
        &lt;/a&gt; par exemple).&lt;a href="#fnref:3"&gt;↩&lt;/a&gt;
      &lt;/p&gt;
    &lt;/li&gt;
  &lt;/ol&gt;
&lt;/div&gt;
</content>
  </entry>
  <entry>
    <id>tag:grim7reaper.github.io,2016-10-11:/blog/2016/10/11/a-la-recherche-de-lespace-disque-perdu/</id>
    <title type="html">À la recherche de l’espace (disque) perdu…</title>
    <published>2016-10-11T00:00:00Z</published>
    <updated>2016-10-11T00:00:00Z</updated>
    <link rel="alternate" href="https://grim7reaper.github.io/blog/2016/10/11/a-la-recherche-de-lespace-disque-perdu/" type="text/html"/>
    <content type="html">&lt;p&gt;
  La semaine dernière j’ai aidé à résoudre un problème assez surprenant : une
  partition racine pleine selon &lt;code&gt;df&lt;/code&gt; (ou
  &lt;a href="https://projects.gw-computing.net/projects/dfc"&gt;dfc&lt;/a&gt;) :
&lt;/p&gt;


    &lt;figure class="code"&gt;
      &lt;figcaption&gt;df -h&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;pre&gt;FILESYSTEM               (=) USED      FREE (-)  %USED AVAILABLE  TOTAL MOUNTED ON
[…]
/dev/dm-0                [====================]   100%     15.6G  15.6G /
[…]
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Mais lorsque l’on essaye de trouver les coupables via
  &lt;a href="https://dev.yorhel.nl/ncdu"&gt;ncdu&lt;/a&gt;, la somme est loin de faire
  16Go :
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;ncdu -x&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;pre&gt;    .   3.8GiB [##########] /var
        1.2GiB [###       ] /srv
      885.2MiB [##        ] /opt
      223.0MiB [          ] /lib
    .  95.4MiB [          ] /etc
    […]
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;Surprenant !&lt;/p&gt;

&lt;h2&gt;Les fichiers perdus dans les limbes&lt;/h2&gt;

&lt;p&gt;
  Après réflexion, je me suis souvenu que certains fichiers pouvaient rester
  bloqués dans les limbes. En effet, il faut savoir que, sous Linux, quand un
  fichier est supprimé (avec &lt;code&gt;rm&lt;/code&gt; par exemple), il n’est pas
  réellement supprimé tant qu’au moins un processus utilise ledit fichier. Par
  conséquent, même si le fichier n’est plus affiché par &lt;code&gt;ls&lt;/code&gt;
  ou &lt;code&gt;find&lt;/code&gt;, il occupe toujours de l’espace sur le disque.
&lt;/p&gt;

&lt;p&gt;
  Pour lister ces fichiers, on ne peut pas utiliser les commandes habituelles
  telles que &lt;code&gt;ls&lt;/code&gt; ou &lt;code&gt;find&lt;/code&gt;, mais on peut
  utiliser &lt;code&gt;lsof&lt;/code&gt; qui est une commande qui liste les fichiers ouverts
  (&lt;code&gt;lsof&lt;/code&gt; =&gt; &lt;em&gt;list open files&lt;/em&gt;). La sortie
  de &lt;code&gt;lsof&lt;/code&gt; est très verbeuse, heureusement en lisant sa page de
  manuel (&lt;code&gt;man 8 lsof&lt;/code&gt;) on y trouve l’option &lt;code&gt;L&lt;/code&gt; qui peut
  être suivi d’un nombre. Lorsque &lt;code&gt;L&lt;/code&gt; est suivi d’un
  nombre &lt;code&gt;N&lt;/code&gt;, &lt;code&gt;lsof&lt;/code&gt; va uniquement lister les fichiers qui
  sont référencé un nombre de fois strictement inférieur à &lt;code&gt;N&lt;/code&gt;. Dans
  notre cas, comme on veut lister les fichiers supprimés (qui ne sont donc plus
  référencés) il faut utiliser &lt;code&gt;L1&lt;/code&gt; pour lister les fichier ayant 0
  référence.
&lt;/p&gt;

&lt;p&gt;
  En combinant &lt;code&gt;lsof +L1&lt;/code&gt; avec la commande &lt;code&gt;sort&lt;/code&gt; on peut
  trier par taille pour voir quels sont les fichiers occupant le plus de place.
&lt;/p&gt;

&lt;p&gt;
  La commande finale est donc &lt;code&gt;lsof -s +L1 | sort -nk7&lt;/code&gt; ce qui se
  traduit par : liste (&lt;code&gt;lsof&lt;/code&gt;) la taille (&lt;code&gt;-s&lt;/code&gt;) de tout
  les fichiers supprimés et encore ouvert (&lt;code&gt;+L1&lt;/code&gt;) et trie
  (&lt;code&gt;sort&lt;/code&gt;) cette liste de manière numérique (&lt;code&gt;-n&lt;/code&gt;) sur le
  champs 7 (&lt;code&gt;-k7&lt;/code&gt;, car c’est le septième champs qui est le champ de
  la taille).
&lt;/p&gt;

    &lt;figure class="code"&gt;
      &lt;figcaption&gt;Exemple de sortie&lt;/figcaption&gt;
      &lt;div class="highlight"&gt;
        &lt;pre&gt;% lsof -s +L1 | sort -nk7

COMMAND  PID        USER   FD   TYPE DEVICE    SIZE NLINK    NODE NAME
conky   5372 grim7reaper    0u   CHR 136,16             0      19 /dev/pts/16 (deleted)
conky   5372 grim7reaper    1u   CHR 136,16             0      19 /dev/pts/16 (deleted)
conky   5372 grim7reaper    2u   CHR 136,16             0      19 /dev/pts/16 (deleted)
systemd  709 grim7reaper  txt    REG  254,2 1018520     0 1619496 /usr/lib/systemd/systemd (deleted)
&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/figure&gt;


&lt;p&gt;
  Cette commande a permis de découvrir que l’espace disque était utilisé par des
  fichiers temporaires de
  &lt;a href="https://gnometerminator.blogspot.fr/p/introduction.html"&gt;Terminator&lt;/a&gt;.
&lt;/p&gt;

&lt;h2&gt;Terminator et libVTE&lt;/h2&gt;

&lt;p&gt;Reste à savoir pourquoi Terminator utilise autant d’espace disque.&lt;/p&gt;

&lt;p&gt;
  Tout d’abord il faut savoir que le Terminator en cause ici était configuré
  pour conserver toutes les sorties des terminaux, sans limite
  (option &lt;em&gt;Inifinite scrollback&lt;/em&gt;). Le problème c’est que
  les &lt;em&gt;buffers&lt;/em&gt; des terminaux sont stockés sur disques et donc que plus
  les terminaux sont utilisés longtemps et plus il y’a de choses affichées
  dedans, plus l’espace disque occupé va augmenter.
&lt;/p&gt;

&lt;p&gt;
  Ce comportement ne vient pas de Terminator lui-même, mais de la
  &lt;a href="https://github.com/GNOME/vte"&gt;libVTE&lt;/a&gt; qui est une bibliothèque
  utilisée pour implémenter des émulateurs de terminaux. Ce bug touche donc tout
  les terminaux basés sur libVTE (Terminator, Gnome-Terminal, xfce4-terminal,
  guake, …).
&lt;/p&gt;

&lt;p&gt;
  Ce comportement existe depuis 2009, il est connu et ne sera probablement pas
  corrigé, alors même que cela peut poser problème (je vous conseille de lire
  &lt;a href="http://climagic.org/bugreports/libvte-scrollback-written-to-disk.html"&gt;ce rapport de bug&lt;/a&gt;
  qui explique bien la situation)…
&lt;/p&gt;

&lt;h2&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;
  Je pense que je vais continuer d’utiliser
  &lt;a href="https://web.archive.org/web/20161003144517/https://en.wikipedia.org/wiki/Rxvt-unicode"&gt;urxvt&lt;/a&gt; :D, qui est
  l’un des rares terminaux à bien gérer l’espace insécable fine et qui n’est pas
  basé sur libVTE. Cette petite mésaventure m’aura au moins fait découvrir un
  aspect fort utile de &lt;code&gt;lsof&lt;/code&gt;.
&lt;/p&gt;
</content>
  </entry>
</feed>

